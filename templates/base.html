{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="add-transaction-url" content="{% url 'add_transaction' %}">
  <meta name="delete-transaction-url" content="{% url 'delete_transaction' %}">
  <meta name="update-transaction-url" content="{% url 'update_transaction' %}">
  <meta name="toggle-save-transaction-url" content="{% url 'toggle_save_transaction' %}">
  <meta name="add-category-url" content="{% url 'add_category' %}">
  <meta name="delete-category-url" content="{% url 'delete_category' %}">
  <meta name="add-budget-url" content="{% url 'add_budget' %}">
  <meta name="update-budget-url" content="{% url 'update_budget' %}">
  <meta name="delete-budget-url" content="{% url 'delete_budget' %}">
  <meta name="get-budgets-url" content="{% url 'get_budgets' %}">
  <meta name="get-currencies-url" content="{% url 'get_currencies' %}">
  <meta name="get-available-currencies-url" content="{% url 'get_available_currencies' %}">
  <meta name="add-currency-url" content="{% url 'add_currency' %}">
  <meta name="delete-currency-url" content="{% url 'delete_currency' %}">
  <meta name="add-account-url" content="{% url 'add_account' %}">
  <meta name="delete-account-url" content="{% url 'delete_account' %}">
  <meta name="get-accounts-url" content="{% url 'get_accounts' %}">
  <meta name="order-accounts-url" content="{% url 'order_accounts' %}">
  <title>{% block title %}Wallet Notes{% endblock %}</title>
  <link rel="icon" type="image/jpeg" href="{% static 'img/favicon.jpg' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    .sidebar {
      height: 100vh;
      background: #343a40;
      color: white;
      padding: 20px;
      transition: all 0.3s ease;
      position: fixed;
      z-index: 1000;
    }
    .sidebar.collapsed {
      width: 60px !important;
      padding: 20px 10px;
    }
    .sidebar.collapsed .sidebar-text,
    .sidebar.collapsed h4 {
      display: none;
    }
    /* .sidebar.collapsed .sidebar-logo {
      margin-right: 0;
    } */
    .sidebar.collapsed .logout-btn {
      left: 10px;
      /* width: 40px; */
      justify-content: center;
    }
    .sidebar.collapsed .logout-btn span {
      display: none;
    }
    .main-content {
      transition: all 0.3s ease;
      margin-left: 16.666667%;
    }
    .main-content.expanded {
      margin-left: 60px;
    }
    .sidebar a {
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      padding: 10px;
      white-space: nowrap;
    }
    .sidebar a:hover,
    .hamburger-btn:hover {
      background: #495057;
    }
    .active {
      background: #6c757d !important;
    }
    .sidebar-logo {
      width: 20px;
      height: 20px;
      margin-right: 10px;
    }
    .logout-btn {
      position: absolute;  
      bottom: 20px;
      left: 20px;
      color: white;
      text-decoration: none;
      padding: 10px;
      display: flex;
      align-items: center;
    }
    .logout-btn:hover {
      color: #ff4444;
    }
    #categorySelect {
      height: 25px;
      font-size: 10px;
    }
    .hamburger-btn {
      position: relative;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .hamburger-btn i {
      font-size: 20px;
      margin: 0;
    }
    .sidebar.collapsed .hamburger-btn {
      width: 40px;
      height: 40px;
      padding: 10px;
    }
    .title-container {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      width: 100%;
      overflow: hidden;
    }
    .title-container h4 {
      margin: 0;
      margin-left: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .drag-handle {
      cursor: grab;
      padding: 6px 8px;
      display: inline-block;
      vertical-align: middle;
      color: #6c757d;
    }
    .drag-handle:hover {
      color: #333;
    }
    .dragging {
      opacity: 0.5;
      background-color: #f8f9fa;
    }
    .drop-target {
      border-top: 2px solid #0d6efd;
    }
    .sortable-table tr {
      transition: all 0.2s ease;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Side Bar -->
      <nav class="col-md-2 d-md-block sidebar">
        <div class="title-container">
          <button class="hamburger-btn">
            <i class="bi bi-list"></i>
          </button>
          <h4>Wallet Notes</h4>
        </div>
        <a href="{% url 'detail' %}" id="detail-link" class="{% block active_detail %}{% endblock %}">
          <img src="{% static 'img/detail.png' %}" alt="Detail Logo" class="sidebar-logo">
          <span class="sidebar-text">Detail</span>
        </a>
        <a href="{% url 'statistics' %}" id="statistics-link" class="{% block active_statistics %}{% endblock %}">
          <img src="{% static 'img/statistics.png' %}" alt="Statistics Logo" class="sidebar-logo">
          <span class="sidebar-text">Statistics</span>
        </a>
        <a href="{% url 'management' %}" id="management-link" class="{% block active_management %}{% endblock %}">
          <img src="{% static 'img/management.png' %}" alt="Management Logo" class="sidebar-logo">
          <span class="sidebar-text">Management</span>
        </a>
        <a href="{% url 'user_instruction' %}" id="user-instruction-link" class="{% block active_user_instruction %}{% endblock %}">
          <img src="{% static 'img/instruction.png' %}" alt="User Instruction Logo" class="sidebar-logo">
          <span class="sidebar-text">User Instruction</span>
        </a>
        <a href="{% url 'contact' %}" id="contact-link" class="{% block active_contact %}{% endblock %}">
          <img src="{% static 'img/contact.png' %}" alt="Contact Logo" class="sidebar-logo">
          <span class="sidebar-text">Contact Us</span>
        </a>
        <a href="{% url 'logout' %}" class="logout-btn">
          <i class="bi bi-box-arrow-left"></i>
          <span>&nbsp;&nbsp;Logout</span>
        </a>
      </nav>
      
      <!-- Main Content -->
      <main class="col-md-10 p-4 main-content">
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>
  
  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">Edit Transaction</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <div class="mb-3">
              <label for="editDate" class="form-label">Date</label>
              <input type="date" class="form-control" id="editDate" required>
            </div>
            <div class="mb-3">
              <label for="editType" class="form-label">Type</label>
              <select class="form-select" id="editType">
                <option value="true">Income</option>
                <option value="false">Expense</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editCategory" class="form-label">Category</label>
              <select class="form-select" id="editCategory"></select>
            </div>
            <div class="mb-3">
              <label for="editCurrency" class="form-label">Currency</label>
              <select class="form-select" id="editCurrency">
                <option value="GBP">GBP</option>
                <option value="EUR">EUR</option>
                <option value="USD">USD</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editAmount" class="form-label">Amount</label>
              <input type="text" class="form-control" id="editAmount" required>
            </div>
            <div class="mb-3">
              <label for="editAccount" class="form-label">Account</label>
              <select class="form-select" id="editAccount"></select>
            </div>
            <div class="mb-3">
              <label for="editDescription" class="form-label">Description</label>
              <input type="text" class="form-control" id="editDescription">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveChanges">Save changes</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Modal -->
  <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addModalLabel">Add Transaction</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addForm">
            <div class="mb-3">
              <label for="addDate" class="form-label">Date</label>
              <input type="date" class="form-control" id="addDate" required>
            </div>
            <div class="mb-3">
              <label for="addType" class="form-label">Type</label>
              <select class="form-select" id="addType">
                <option value="true">Income</option>
                <option value="false">Expense</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="addCategory" class="form-label">Category</label>
              <select class="form-select" id="addCategory" required></select>
            </div>
            <div class="mb-3">
              <label for="addCurrency" class="form-label">Currency</label>
              <select class="form-select" id="addCurrency">
                <option value="GBP">GBP</option>
                <option value="EUR">EUR</option>
                <option value="USD">USD</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="addAmount" class="form-label">Amount</label>
              <input type="text" class="form-control" id="addAmount" required>
            </div>
            <div class="mb-3">
              <label for="addedAccount" class="form-label">Account</label>
              <select class="form-select" id="addedAccount" required></select>
            </div>
            <div class="mb-3">
              <label for="addDescription" class="form-label">Description</label>
              <input type="text" class="form-control" id="addDescription">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="addTransaction">Add</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Income Category Modal -->
  <div class="modal fade" id="addIncomeCategoryModal" tabindex="-1" aria-labelledby="addIncomeCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addIncomeCategoryModalLabel">Add Income Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addIncomeCategoryForm">
            <div class="mb-3">
              <label for="incomeCategoryName" class="form-label">Name</label>
              <input type="text" class="form-control" id="incomeCategoryName" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveIncomeCategory">Save</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Expense Category Modal -->
  <div class="modal fade" id="addExpenseCategoryModal" tabindex="-1" aria-labelledby="addExpenseCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addExpenseCategoryModalLabel">Add Expense Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addExpenseCategoryForm">
            <div class="mb-3">
              <label for="expenseCategoryName" class="form-label">Name</label>
              <input type="text" class="form-control" id="expenseCategoryName" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveExpenseCategory">Save</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Budget Modal -->
  <div class="modal fade" id="addBudgetModal" tabindex="-1" aria-labelledby="addBudgetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addBudgetModalLabel">Add Budget</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addBudgetForm">
            <div class="mb-3">
              <label for="budgetYearMonth" class="form-label">Year-Month</label>
              <input type="month" class="form-control" id="budgetYearMonth" required>
            </div>
            <div class="mb-3">
              <label for="addCategory" class="form-label">Category</label>
              <select class="form-select" id="budgetCategory" required></select>
            </div>
            <div class="mb-3">
              <label for="budgetAmount" class="form-label">Budget Amount</label>
              <input type="text" class="form-control" id="budgetAmount" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveBudget">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Budget Modal -->
  <div class="modal fade" id="editBudgetModal" tabindex="-1" aria-labelledby="editBudgetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editBudgetModalLabel">Edit Budget</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editBudgetForm">
            <input type="hidden" id="editBudgetId">
            <div class="mb-3">
              <label for="editBudgetYearMonth" class="form-label">Year-Month</label>
              <input type="month" class="form-control" id="editBudgetYearMonth" required>
            </div>
            <div class="mb-3">
              <label for="editBudgetCategory" class="form-label">Category</label>
              <select class="form-select" id="editBudgetCategory" required></select>
            </div>
            <div class="mb-3">
              <label for="editBudgetAmount" class="form-label">Budget Amount</label>
              <input type="text" class="form-control" id="editBudgetAmount" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="updateBudget">Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Currency Modal -->
  <div class="modal fade" id="addCurrencyModal" tabindex="-1" aria-labelledby="addCurrencyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addCurrencyModalLabel">Add Currency</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addCurrencyForm">
            <div class="mb-3">
              <label for="currency" class="form-label">Currency</label>
              <select class="form-control" id="currencySelect">
                <option value="">-- Select Currency --</option>
                <optgroup label="System Currencies">
                  <option value="GBP">GBP</option>
                  <option value="EUR">EUR</option>
                  <option value="USD">USD</option>
                </optgroup>
              </select>
            </div>
            <div class="mb-3">
              <label for="newCurrencyCode" class="form-label">Or Add New Currency Code</label>
              <input type="text" class="form-control" id="newCurrencyCode" placeholder="e.g. JPY">
            </div>
            <div class="mb-3">
              <label for="exchangeRate" class="form-label">Exchange Rate</label>
              <input type="number" step="0.0001" class="form-control" id="exchangeRate" required>
            </div>
          </form>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="saveCurrency">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Account Modal -->
  <div class="modal fade" id="addAccountModal" tabindex="-1" aria-labelledby="addAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addAccountModalLabel">Add Account</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addAccountForm">
            <div class="mb-3">
              <label for="account" class="form-label">Account Name</label>
              <input type="text" class="form-control" id="accountName" required>
            </div>
            <div class="mb-3">
              <label for="addAccount" class="form-label">Account Type</label>
              <select class="form-select" id="addAccount">
                <option value="Cash">Cash</option>
                <option value="Bank">Bank Account</option>
                <option value="Credit Card">Credit Card</option>
                <option value="Debit Card">Debit Card</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="balance" class="form-label">Balance</label>
              <input type="text" class="form-control" id="addBalance" required>
            </div>
          </form>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="saveAccount">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  {% block page_scripts %}{% endblock %}

  <script>
    let currentEditIndex = null;
    // Store current filter state
    let currentFilterState = {
      transactionType: 'all',
      category: 'all'
    }

    // Sidebar collapse
    document.addEventListener('DOMContentLoaded', function() {
      const toggleBtn = document.querySelector('.hamburger-btn');
      const sidebar = document.querySelector('.sidebar');
      const mainContent = document.querySelector('.main-content');
      
      // Function to check if device is mobile
      function isSmallScreen() {
        return window.innerWidth <= 768;
      }
      
      // Initialize sidebar state based on screen size
      function initializeSidebarState() {
        const savedState = localStorage.getItem('sidebarCollapsed');
        
        if (savedState !== null) {
          if (savedState === 'true') {
            sidebar.classList.add('collapsed');
            mainContent.classList.add('expanded');
          }
          return;
        }
        
        // Set default state based on screen size
        if (isSmallScreen()) {
          sidebar.classList.add('collapsed');
          mainContent.classList.add('expanded');
          localStorage.setItem('sidebarCollapsed', 'true');
        } else {
          sidebar.classList.remove('collapsed');
          mainContent.classList.remove('expanded');
          localStorage.setItem('sidebarCollapsed', 'false');
        }
      }
      
      // Initialize on page load
      initializeSidebarState();
      
      // Handle window resize
      window.addEventListener('resize', function() {
        // Only change state if there's no saved preference
        if (localStorage.getItem('sidebarCollapsed') === null) {
          initializeSidebarState();
        }
      });
      
      toggleBtn.addEventListener('click', function() {
        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('expanded');
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
      });
    });

    // Filter transactions
    function getFilteredTransactions(){
      if(!window.transactions || !Array.isArray(window.transactions)) return [];

      let filtered = [...window.transactions];
      
      if (currentFilterState.transactionType === 'in') {
        filtered = filtered.filter(t => t.transaction_type === true);
      } else if (currentFilterState.transactionType === 'out') {
        filtered = filtered.filter(t => t.transaction_type === false);
      }

      if (currentFilterState.category !== 'all') {
        filtered = filtered.filter(t => t.category === currentFilterState.category);
      }

      return filtered;
    }

    // Update filter state and re-render tables
    function updateFilterState(filterType, value) {
      if (filterType === 'transactionType') {
        currentFilterState.transactionType = value;
        
        // highlight active button
        document.querySelectorAll('.btn-secondary, .btn-success, .btn-danger').forEach(btn => {
          btn.classList.remove('active');
        });
        
        if (value === 'all') {
          document.querySelector('.btn-secondary').classList.add('active');
        } else if (value === 'in') {
          document.querySelector('.btn-success').classList.add('active');
        } else if (value === 'out') {
          document.querySelector('.btn-danger').classList.add('active');
        }
      } else if (filterType === 'category') {
        currentFilterState.category = value;
      }

      const filteredData = getFilteredTransactions();
      refreshTables();
    }

    function filterTransactions(type) {
      updateFilterState('transactionType', type);
    }

    function filterCategory() {
      const filterEl = document.getElementById('category-filter');
      if (!filterEl) return;

      const selectedCategory = filterEl.value;
      updateFilterState('category', selectedCategory);
    }

    function refreshTables() {
      if (!document.getElementById('detail-page')) {
          console.log('Not on detail page, skipping table refresh.');
          return;
      }

      const filteredData = getFilteredTransactions();
      updateTable(filteredData, "transaction-table-month");
      updateTable(filteredData, "transaction-table-category");
      updateTable(filteredData, "transaction-table-saved");
    }

    function updateTable(data, tableId) {
        const tableElement = document.getElementById(tableId);
        if (!tableElement) {
            console.log(`Table with id ${tableId} not found, skipping update.`);
            return;
        }

        const isSavedView = tableId === "transaction-table-saved";
        
        let displayData = data;
        if (isSavedView) {
            displayData = data.filter(t => t.is_saved === true);
        }

        let tableContent = displayData.map((t, index) => {
            const btnClass = t.is_saved ? "btn-secondary" : "btn-success";
            const btnText = t.is_saved ? "Unsave" : "Save";
            
            return `<tr>
                <td>${t.date}</td>
                <td>${t.category}</td>
                <td>${t.transaction_type ? "Income" : "Expense"}</td>
                <td>${t.currency}</td>
                <td>${t.amount}</td>
                <td>${t.account_name}</td>
                <td>${t.description}</td>
                <td>
                    <button class="btn ${btnClass} btn-sm" onclick="toggleSaveTransaction(${index}, ${isSavedView})">
                        ${btnText}
                    </button>
                </td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="openEditModal(${index})">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTransaction(${index})">Delete</button>
                </td>
            </tr>`;
        }).join('');
        
        tableElement.innerHTML = tableContent || '<tr><td colspan="9" class="text-center">No data available</td></tr>';
    }

    function findOriginalIndex(transactionId) {
        return window.transactions.findIndex(t => t.id === transactionId);
    }

    function isInSavedTab() {
        return document.querySelector('#by-saved.active, #by-saved.show.active') !== null;
    }

    function toggleSaveTransaction(index, fromSavedView = false) {
        let transaction;
        let originalIndex;
        
        if (fromSavedView) {
            const savedTransactions = getFilteredTransactions().filter(t => t.is_saved);
            if (index >= savedTransactions.length) {
                console.error('Invalid index for saved transactions');
                return;
            }
            transaction = savedTransactions[index];
            originalIndex = window.transactions.findIndex(t => t.id === transaction.id);
            if (originalIndex === -1) {
                console.error('Transaction not found in original array');
                return;
            }
        } else {
            transaction = window.transactions[index];
            originalIndex = index;
        }

        if (!transaction || !transaction.id) {
            console.error('Invalid transaction or missing ID');
            return;
        }

        const transactionId = transaction.id;
        const currentSavedState = transaction.is_saved;

        console.log(`Toggling transaction ${transactionId} with current saved state: ${currentSavedState}`);
        console.log(`Operating from saved view: ${fromSavedView}`);
        
        let saveUrl = 'toggle-save-transaction/';
        const urlMeta = document.querySelector('meta[name="toggle-save-transaction-url"]');
        if (urlMeta) {
            saveUrl = urlMeta.getAttribute('content');
        }
        
        fetch(saveUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `transaction_id=${transactionId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                window.transactions[originalIndex].is_saved = data.is_saved;
                                
                if (fromSavedView && !data.is_saved) {
                    console.log('Removing transaction from saved tab');
                } else {
                    console.log(`Transaction ${data.is_saved ? 'saved' : 'unsaved'} successfully`);
                }
                refreshTables();
            } else {
                console.error('Failed to toggle save status:', data.message);
                alert(`Failed to update: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the transaction');
        });
    }

    // Open Add Transaction Modal
    function openAddModal() {
      // Set current date as default
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('addDate').value = today;
      
      // Reset form fields
      document.getElementById('addType').value = 'false'; // Default to expense
      document.getElementById('addAmount').value = '';
      document.getElementById('addDescription').value = '';
      
      // Update dropdowns with latest data
      updateCategoryDropdown();
      updateAccountDropdown();
      updateTransactionCurrencyDropdown('addCurrency');
      
      // Show modal
      const addModal = new bootstrap.Modal(document.getElementById('addModal'));
      addModal.show();
    }

    // Open Edit Transaction Modal
    function openEditModal(index) {
      const transaction = window.transactions[index];
      if (!transaction) {
        console.error('Transaction not found at index:', index);
        return;
      }
      
      // Store the current index for later use
      currentEditIndex = index;

      // Fill form fields with transaction data
      document.getElementById('editDate').value = transaction.date;
      document.getElementById('editType').value = transaction.transaction_type ? "true" : "false";
      
      // Update category dropdown based on transaction type
      updateEditCategoryDropdown(transaction.transaction_type ? "true" : "false");
      
      // Set values after dropdowns are populated
      setTimeout(() => {
        // Find and select the correct category
        const editCategoryElement = document.getElementById('editCategory');
        if (editCategoryElement) {
          // Try to find the option with matching text
          for (let i = 0; i < editCategoryElement.options.length; i++) {
            if (editCategoryElement.options[i].text === transaction.category) {
              editCategoryElement.selectedIndex = i;
              break;
            }
          }
        }
        
        // Currency
        const editCurrencyElement = document.getElementById('editCurrency');
        if (editCurrencyElement) {
          for (let i = 0; i < editCurrencyElement.options.length; i++) {
            if (editCurrencyElement.options[i].value === transaction.currency) {
              editCurrencyElement.selectedIndex = i;
              break;
            }
          }
        }
        
        // Account
        const editAccountElement = document.getElementById('editAccount');
        if (editAccountElement) {
          for (let i = 0; i < editAccountElement.options.length; i++) {
            if (editAccountElement.options[i].value === transaction.account_name) {
              editAccountElement.selectedIndex = i;
              break;
            }
          }
        }
      }, 100);

      updateEditAccountDropdown();
      
      document.getElementById('editAmount').value = transaction.amount;
      document.getElementById('editDescription').value = transaction.description || '';

      // Show modal
      const editModal = new bootstrap.Modal(document.getElementById('editModal'));
      editModal.show();
    }
    
    function updateEditCategoryDropdown(type) {
      const categoryDropdown = document.getElementById('editCategory');
      if (!categoryDropdown) return;
      
      categoryDropdown.innerHTML = '';
      
      if (!window.categories || !window.categories[type]) {
        console.error('Categories not defined or invalid type:', type);
        return;
      }
      
      window.categories[type].forEach(category => {
        const option = document.createElement('option');
        option.value = category.name;
        option.textContent = category.name;
        categoryDropdown.appendChild(option);
      });
      console.log('Updated edit category dropdown:', window.categories[type]);
    }

     // Update drop-down box
     function updateCategoryDropdown() {
      const categoryDropdown = document.getElementById('addCategory');
      const addTypeEl = document.getElementById('addType');
      if (!categoryDropdown || !addTypeEl) return;

      const selectedType = addTypeEl.value;
      categoryDropdown.innerHTML = '';

      if (!window.categories || !window.categories[selectedType]) {
        console.error('Categories not defined or invalid type:', selectedType);
        return;
      }

      window.categories[selectedType].forEach(category => {
        const option = document.createElement('option');
        option.value = category.name; // 使用 category name 作為值
        option.textContent = category.name;
        categoryDropdown.appendChild(option);
      });
      console.log('Updated category dropdown:', window.categories[selectedType]);
    }

    function updateBudgetCategoryDropdown(elementId = 'budgetCategory') {
      const categoryDropdown = document.getElementById(elementId);
      if (!categoryDropdown) return;

      categoryDropdown.innerHTML = '';

      // 添加一個預設選項
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = '-- Select Category --';
      categoryDropdown.appendChild(defaultOption);

      // 添加所有支出類別
      if (window.categories && window.categories['false']) {
        window.categories['false'].forEach(category => {
          const option = document.createElement('option');
          option.value = category.id;
          option.textContent = category.name;
          categoryDropdown.appendChild(option);
        });
      }
    }

    function updateAccountDropdown() {
      const accountDropdown = document.getElementById('addedAccount');
      if (!accountDropdown) return;
      
      accountDropdown.innerHTML = '';
      
      if (!window.accounts || !Array.isArray(window.accounts)) {
        console.error('Accounts not defined or not an array');
        return;
      }
      
      window.accounts.forEach(account => {
        const option = document.createElement('option');
        option.value = account.account_name;
        option.textContent = account.account_name;
        accountDropdown.appendChild(option);
      });
      
      console.log('Updated account dropdown with accounts:', window.accounts.length);
    }

    // 同樣為編輯模態框創建更新函數
    function updateEditAccountDropdown() {
      const accountDropdown = document.getElementById('editAccount');
      if (!accountDropdown) return;
      
      accountDropdown.innerHTML = '';
      
      if (!window.accounts || !Array.isArray(window.accounts)) {
        console.error('Accounts not defined or not an array');
        return;
      }
      
      window.accounts.forEach(account => {
        const option = document.createElement('option');
        option.value = account.account_name;
        option.textContent = account.account_name;
        accountDropdown.appendChild(option);
      });
    }

    function deleteTransaction(index) {
      const transactionId = transactions[index].id;
      console.log('Deleting transaction:', transactionId);

      let deleteUrl = 'delete-transaction/';
      const urlMeta = document.querySelector('meta[name="delete-transaction-url"]');
      if (urlMeta) {
        deleteUrl = urlMeta.getAttribute('content');
      }
      
      console.log('Delete URL:', deleteUrl);

      fetch(deleteUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `transaction_id=${transactionId}`
      })
      .then(response => {
        console.log('HTTP response status:', response.status);
        return response.text();
      })
      .then(text => {
        console.log('Response text:', text);
        // try analyzing JSON, if failed, return original text
        try {
          return JSON.parse(text);
        } catch (e) {
          console.error('Failed to parse JSON:', e);
          return { status: 'error', message: 'Invalid JSON response: ' + text };
        }
      })
      .then(data => {
        console.log('Parsed data:', data);
        if (data.status === 'success') {
          transactions.splice(index, 1);
          refreshTables();
          console.log('Transaction deleted successfully:', data.message);
        } else {
          console.error('Failed to delete:', data.message);
          alert(`Failed to delete: ${data.message}`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the transaction. Please check console.');
      });
    }

    // For Statistics Page
    function initStatisticsPage() {
      console.log('Initializing statistics page...');

      // Get transaction data from backend
      fetch('/api/transactions/dates/')
        .then(response => response.json())
        .then(data => {
          window.monthsByYear = data.monthsByYear; 
          initYearOptions(data.years);
          initMonthOptions(data.monthsByYear[Math.max(...data.years)]);  // init month options for the latest year
          switchMode('month');
          
          // Initialize budget pie chart category select with "entire_period"
          const categorySelect = document.getElementById('categorySelect');
          if (categorySelect) {
            categorySelect.value = 'entire_period';
            // initial budget pie chart 
            updateCharts(document.getElementById('monthSelect').parentElement.style.display === 'none' ? 'year' : 'month');
          }
        })
        .catch(error => {
          console.error('Error fetching transaction dates:', error);
        });

      // Add event listener for budget pie chart category select
      const categorySelect = document.getElementById('categorySelect');
      if (categorySelect) {
        categorySelect.addEventListener('change', function() {
          const selectedCategory = this.value;
          const mode = document.getElementById('monthSelect').parentElement.style.display === 'none' ? 'year' : 'month';
          updateCharts(mode);
        });
      }
    }

    function initYearOptions(availableYears) {
      const yearSelect = document.getElementById('yearSelect');
      if (!yearSelect) return;

      yearSelect.innerHTML = ''; // clear existing options
      
      // generate options based on available years
      availableYears.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      });

      // set the latest year as default
      if (availableYears.length > 0) {
        yearSelect.value = Math.max(...availableYears);
      }
    }

    function initMonthOptions(availableMonths) {
      const monthSelect = document.getElementById('monthSelect');
      if (!monthSelect) return;

      monthSelect.innerHTML = ''; // clear existing options
    
      const monthNames = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
      ];

      // generate options based on available months
      availableMonths.forEach(month => {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = monthNames[month - 1];
        monthSelect.appendChild(option);
      });

      // set the latest month as default
      if (availableMonths.length > 0) {
        monthSelect.value = Math.max(...availableMonths);
      }
    }

    function switchMode(mode) {
      // update button status
      document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.classList.remove('active');
      });
      const activeBtn = document.querySelector(`.filter-btn[onclick="switchMode('${mode}')"]`);
      if (activeBtn) {
        activeBtn.classList.add('active');
      }

      // handle month dropdown
      const monthSelect = document.getElementById('monthSelect');
      const yearSelect = document.getElementById('yearSelect');
      
      if (monthSelect) {
        const monthSelectContainer = monthSelect.parentElement;
    
        if (mode === 'year') {
          monthSelectContainer.style.display = 'none'; // hide the month dropdown
          monthSelect.disabled = true;
          monthSelect.value = '';
        } else {
          // when switch to month mode
          monthSelectContainer.style.display = ''; // show the month dropdown
          monthSelect.disabled = false;
          monthSelect.style.color = '';
          
          // automatically select the latest month
          const selectedYear = yearSelect.value;
          
          if (window.monthsByYear && window.monthsByYear[selectedYear]) {
            const availableMonths = window.monthsByYear[selectedYear];
            const latestMonth = Math.max(...availableMonths);
            monthSelect.value = latestMonth;
          }
        }
      }
      updateCharts(mode);
    }

    function handleYearChange() {
      const yearSelect = document.getElementById('yearSelect');
      if (yearSelect) {
        const selectedYear = yearSelect.value;
        
        // update month options
        if (window.monthsByYear && window.monthsByYear[selectedYear]) {
          initMonthOptions(window.monthsByYear[selectedYear]);
        }
        
        // keep current mode unchanged
        const currentMode = document.getElementById('monthSelect').parentElement.style.display === 'none' ? 'year' : 'month';
        updateCharts(currentMode);
      }
    }

    function handleMonthChange() {
      if (document.getElementById('monthSelect') && !document.getElementById('monthSelect').disabled) {
        updateCharts('month');  
      }
    }

    function updateCharts(mode) {
      const yearSelect = document.getElementById('yearSelect');
      const monthSelect = document.getElementById('monthSelect');
      
      if (!yearSelect) return;

      const selectedYear = yearSelect.value;
      const selectedMonth = mode === 'month' ? monthSelect.value : null;

      const params = new URLSearchParams();
      params.append('year', selectedYear || '');
      params.append('mode', mode || 'year');
      if (selectedMonth) {
        params.append('month', selectedMonth);
      }

      const url = `/api/statistics/data/?${params.toString()}`;
      
      console.log('Fetching URL:', url);

      fetch(url)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          updateStatistics(data);
          updateBudgetDropdown(data);
        })
        .catch(error => alert('Error updating statistics.')
      );
    }

    function updateBudgetDropdown(data) {
      const categorySelect = document.getElementById('categorySelect');
      if (!categorySelect) return;

      // store current selection before clearing
      const currentSelection = categorySelect.value;

      categorySelect.innerHTML = ''; 

      if (data.budget_data && data.budget_data.category_budgets && Object.keys(data.budget_data.category_budgets).length > 0) {
        // add "entire period" in to list
        const defaultOption = document.createElement('option');
        defaultOption.value = 'entire_period';
        defaultOption.textContent = 'Entire Period';
        categorySelect.appendChild(defaultOption);

        // set options for categories that have budgets
        Object.keys(data.budget_data.category_budgets).forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          categorySelect.appendChild(option);
        });

        // restore previous selection if it still exists in the options, otherwise use "entire_period"
        if (currentSelection && (currentSelection === 'entire_period' || data.budget_data.category_budgets[currentSelection])) {
          categorySelect.value = currentSelection;
        } else {
          categorySelect.value = 'entire_period';
        }

        // trigger chart update immediately if this is the initial load
        if (!currentSelection) {
          const mode = document.getElementById('monthSelect').parentElement.style.display === 'none' ? 'year' : 'month';
          updateBudgetChart(budgetChart, data);
        }
      } else {
        // if there is no budget
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No Data';
        categorySelect.appendChild(option);
      }
    }

    function updateBudgetChart(chart, data) {
      const budgetData = data.budget_data;
      const selectedCategory = document.getElementById('categorySelect').value;

      if (!budgetData || !budgetData.category_budgets) {
        chart.data.labels = ['No Budget Data'];
        chart.data.datasets[0].data = [1];
        chart.data.datasets[0].backgroundColor = ['#E0E0E0'];
        chart.update();
        return;
      }
      
      // get budget data
      let usedAmount = 0;
      let totalAmount = 0;

      if (selectedCategory === 'entire_period') {
        // calculate total amount of all categories
        totalAmount = Object.values(budgetData.category_budgets).reduce((sum, amount) => sum + amount, 0);
        
        // sum up expense by category which has budget
        Object.keys(budgetData.category_budgets).forEach(category => {
          if (data.expense_by_category[category]) {
            usedAmount += data.expense_by_category[category];
          }
        });
      } else if (selectedCategory) {
        usedAmount = data.expense_by_category[selectedCategory] || 0;
        totalAmount = budgetData.category_budgets?.[selectedCategory] || 0;
      }

      const remainingAmount = Math.max(0, totalAmount - usedAmount);
          
      if (totalAmount !== 0) {
        // update budget pie chart
        chart.data.labels = ['Used', 'Remaining'];
        chart.data.datasets[0].data = [usedAmount, remainingAmount];
        chart.data.datasets[0].backgroundColor = ['#A8DFF1', '#ECBA73'];
      } else {
        // no budget data
        chart.data.labels = ['No Budget Data'];
        chart.data.datasets[0].data = [1];
        chart.data.datasets[0].backgroundColor = ['#E0E0E0'];
        chart.data.datasets[0].datalabels.color = '#FFCE56';
      }
      
      chart.update();
    }

    function updateLineChart(data, mode) {

      if (!incomeExpenseChart) return;

      let labels = [];
      let expenseData = [];
      let incomeData = [];
      let balanceData = [];

      if (mode === 'year') {
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        for (let month = 1; month <= 12; month++) {
          labels.push(months[month - 1]);
          const monthData = data.monthly_data?.[month] || { income: 0, expense: 0 };
          expenseData.push(monthData.expense);
          incomeData.push(monthData.income);
          balanceData.push(monthData.income - monthData.expense);
        }
      } else {
        const selectedYear = parseInt(document.getElementById('yearSelect').value);
        const selectedMonth = parseInt(document.getElementById('monthSelect').value);
        
        const daysInMonth = new Date(selectedYear, selectedMonth, 0).getDate();
        
        for (let day = 1; day <= daysInMonth; day++) {
          labels.push(day.toString());
          const dayData = data.daily_data?.[day] || { income: 0, expense: 0 };
          expenseData.push(dayData.expense);
          incomeData.push(dayData.income);
          balanceData.push(dayData.income - dayData.expense);
        }
      }

      // update line chart data
      incomeExpenseChart.data.labels = labels;
      incomeExpenseChart.data.datasets[0].data = expenseData;
      incomeExpenseChart.data.datasets[1].data = incomeData;
      incomeExpenseChart.data.datasets[2].data = balanceData;

      incomeExpenseChart.update();
    }

    function updatePieChart(chart, data, type) {
      const categoryData = data[`${type}_by_category`];
      if (categoryData && Object.keys(categoryData).length > 0) {
        chart.data.labels = Object.keys(categoryData);
        chart.data.datasets[0].data = Object.values(categoryData);
        chart.data.datasets[0].backgroundColor = ['#A8DFF1', '#ECBA73', '#F5E2D4', '#024757', '#E5989B'];
        chart.data.datasets[0].datalabels.color = '#FFCE56';
      } else {
        chart.data.labels = [`No ${type.charAt(0).toUpperCase() + type.slice(1)} Data`];
        chart.data.datasets[0].data = [1];
        chart.data.datasets[0].backgroundColor = ['#E0E0E0'];
        chart.data.datasets[0].datalabels.color = '#FFCE56';
      }
      chart.update();
    }

    function updateRankingTable(data, type) {
      const tableId = type === 'expense' ? 'expenseRankingTable' : 'incomeRankingTable';
      const rankingTable = document.getElementById(tableId);
      if (!rankingTable) return;

      // clear existing content
      rankingTable.innerHTML = '';

      const createEmptyRows = (startIndex, count) => {
        for (let i = startIndex; i < count; i++) {
          const row = document.createElement('tr');
          row.className = `rank-item ${type}${i + 1}`;
          row.innerHTML = `
            <td>${i + 1}</td>
            <td>-</td>
            <td>0.00 £</td>
          `;
          rankingTable.appendChild(row);
        }
      };

      const categoryData = data[`${type}_by_category`];
      if (categoryData && Object.keys(categoryData).length > 0) {
        // convert category and amount to array and sort
        const items = Object.entries(categoryData)
          .map(([category, amount]) => ({category, amount}))
          .sort((a, b) => b.amount - a.amount)
          .slice(0, 5);

        items.forEach((item, index) => {
          const row = document.createElement('tr');
          row.className = `rank-item ${type}${index + 1}`;
          row.innerHTML = `
            <td>${index + 1}</td>
            <td>${item.category}</td>
            <td>${item.amount.toFixed(2)} £</td>
          `;
          rankingTable.appendChild(row);
        });

        // if no data, show 5 empty rows
        createEmptyRows(items.length, 5);
      } else {
        // if no data, show 5 empty rows
        createEmptyRows(0, 5);
      }
    }

    function updateStatistics(data) {
      try {
        console.log('Updating statistics with data:', data);
        
        const formatCurrency = (number) => {
          const prefix = number >= 0 ? '+' : '';
          return `${prefix}${number.toFixed(2)} £`;
        };

        // update statistics block
        const incomeElement = document.querySelector('.stat-item.in h3');
        const expenseElement = document.querySelector('.stat-item.out h3');
        const balanceElement = document.querySelector('.stat-item.balance h3');
        const balanceBox = document.querySelector('.stat-item.balance');
        const mode = document.getElementById('monthSelect').parentElement.style.display === 'none' ? 'year' : 'month';


        if (incomeElement) incomeElement.textContent = formatCurrency(data.income);
        if (expenseElement) expenseElement.textContent = formatCurrency(-data.expense);
        if (balanceElement) {
          balanceElement.textContent = formatCurrency(data.balance);
          if (balanceBox) {
            if (data.balance < 0) {
              balanceBox.style.backgroundColor = '#E50046'; 
            } else if (data.balance > 0) {
              balanceBox.style.backgroundColor = '#1F7D53'; 
            } else {
              balanceBox.style.backgroundColor = ''; 
            }
          }
        }

        //update budget pie chart
        updateBudgetChart(budgetChart, data)
        // update line chart
        updateLineChart(data, mode);
        // update pie charts
        updatePieChart(expenseChart, data, 'expense');
        updatePieChart(incomeChart, data, 'income');
        // update ranking tables
        updateRankingTable(data, 'expense');
        updateRankingTable(data, 'income');
      } catch (error) {
        console.error('Error in updateStatistics:', error);
        throw error;
      }
    }

    // initialize when DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() {
      if (document.getElementById('statistics-page')) {
        initStatisticsPage();
        
        // rebind month selector event
        const monthSelect = document.getElementById('monthSelect');
        const yearSelect = document.getElementById('yearSelect');
        if (monthSelect) {
          monthSelect.addEventListener('change', handleMonthChange);
        }
        if (yearSelect) {
          yearSelect.addEventListener('change', handleYearChange);
        }
      }
    });

    // Edit Transaction Submit Handler
    document.getElementById('saveChanges').addEventListener('click', () => {
      if (currentEditIndex !== null) {
        const transaction = window.transactions[currentEditIndex];
        const transactionId = transaction.id;
        
        const updatedTransaction = {
          date: document.getElementById('editDate').value,
          category: document.getElementById('editCategory').value,
          transaction_type: document.getElementById('editType').value === 'true',
          currency: document.getElementById('editCurrency').value,
          amount: document.getElementById('editAmount').value,
          account: document.getElementById('editAccount').value,
          description: document.getElementById('editDescription').value || ''
        };
        
        // Validate required fields
        if (!updatedTransaction.date || !updatedTransaction.category || !updatedTransaction.amount || !updatedTransaction.account) {
          alert('Please fill in all required fields');
          return;
        }
        
        let updateUrl = 'update-transaction/';
        const updateUrlMeta = document.querySelector('meta[name="update-transaction-url"]');
        if (updateUrlMeta) {
          updateUrl = updateUrlMeta.getAttribute('content');
        }

        // Close the modal
        document.getElementById('saveChanges').blur();
        const editModal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
        editModal.hide();
        
        fetch(updateUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            'id': transactionId,
            'date': updatedTransaction.date,
            'category': updatedTransaction.category,
            'transaction_type': updatedTransaction.transaction_type,
            'currency': updatedTransaction.currency,
            'amount': updatedTransaction.amount,
            'account': updatedTransaction.account,
            'description': updatedTransaction.description
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            // Update local transaction data
            Object.assign(window.transactions[currentEditIndex], updatedTransaction);
            
            // Refresh UI
            refreshTables();
            
            // Reload to get updated category totals
            window.location.reload();
          } else {
            console.error('Failed to update:', data.message);
            alert(`Failed to update: ${data.message}`);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while updating the transaction');
        });
      }
    });

    // Add Transaction Submit Handler
    document.getElementById('addTransaction').addEventListener('click', () => {
      const newTransaction = {
        date: document.getElementById('addDate').value,
        category: document.getElementById('addCategory').value,
        transaction_type: document.getElementById('addType').value === 'true',
        currency: document.getElementById('addCurrency').value,
        amount: document.getElementById('addAmount').value,
        account: document.getElementById('addedAccount').value,
        description: document.getElementById('addDescription').value || ''
      }

      // Validate required fields
      if (!newTransaction.date || !newTransaction.category || !newTransaction.amount || !newTransaction.account) {
        alert('Please fill in all required fields');
        return;
      }

      let addUrl = 'add-transaction/';
      const addUrlMeta = document.querySelector('meta[name="add-transaction-url"]');
      if (addUrlMeta) {
        addUrl = addUrlMeta.getAttribute('content');
      }
      
      fetch(addUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          'date': newTransaction.date,
          'category': newTransaction.category,
          'transaction_type': newTransaction.transaction_type,
          'currency': newTransaction.currency,
          'amount': newTransaction.amount,
          'account': newTransaction.account,
          'description': newTransaction.description
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Add new transaction to local array with returned ID
          newTransaction.id = data.transaction_id;
          newTransaction.is_saved = false; // Default to not saved
          transactions.push(newTransaction);
          
          // Refresh tables and budgets
          refreshTables();
          if (typeof calculateRemainingBudget === 'function') {
            calculateRemainingBudget();
          }

          // Reload page to get updated data
          window.location.reload();
        } else {
          console.error('Failed to add:', data.message);
          alert(`Failed to add: ${data.message}`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while adding the transaction');
      });

      // Close the modal
      const addModal = bootstrap.Modal.getInstance(document.getElementById('addModal'));
      addModal.hide();
    });

    // 用於添加交易表單的貨幣下拉框更新
    function updateTransactionCurrencyDropdown(elementId) {
      const currencyDropdown = document.getElementById(elementId);
      if (!currencyDropdown) return;
      
      // 保留現有選項
      currencyDropdown.innerHTML = '';
      
      // 添加默認選項
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = '-- Select Currency --';
      currencyDropdown.appendChild(defaultOption);
      
      // 添加系統和用戶貨幣
      if (!window.currencies || !Array.isArray(window.currencies) || window.currencies.length === 0) {
        const basicCurrencies = ['GBP', 'EUR', 'USD', 'TWD'];
        basicCurrencies.forEach(code => {
          const option = document.createElement('option');
          option.value = code;
          option.textContent = code;
          currencyDropdown.appendChild(option);
        });
        
        console.log('Using basic default currencies');
      } else {
        window.currencies.forEach(currency => {
          const option = document.createElement('option');
          option.value = currency.currency_code;
          option.textContent = currency.currency_code;
          currencyDropdown.appendChild(option);
        });
        
        console.log('Using server-loaded currencies:', window.currencies.length);
      }
      
      console.log('Updated currency dropdown:', elementId);
      console.log('Options count:', currencyDropdown.options.length);
    }

    function updateCategoryTables() {
      const incomeTable = document.getElementById('income-categories-table');
      const expenseTable = document.getElementById('expense-categories-table');
      
      if (!incomeTable || !expenseTable) {
        console.log('Category tables not found, skipping update');
        return;
      }
      
      if (!window.categories) {
        console.error('Categories not defined');
        return;
      }
      
      console.log('Updating management tables with:', window.categories);
      
      // 更新收入類別表格
      if (Array.isArray(window.categories.true)) {
        incomeTable.innerHTML = window.categories.true.length > 0 ?
          window.categories.true.map(cat => `
            <tr>
              <td>${cat.name}</td>
              <td>${cat.transaction_count}</td>
              <td>£${cat.total_amount}</td>
              <td>
                <button class='btn btn-danger btn-sm' onclick="deleteCategory('true', ${cat.id})">Delete</button>
              </td>
            </tr>
          `).join('') :
          '<tr><td colspan="4" class="text-center">No income categories available</td></tr>';
      }
    
      // 更新支出類別表格
      if (Array.isArray(window.categories.false)) {
        expenseTable.innerHTML = window.categories.false.length > 0 ?
          window.categories.false.map(cat => `
            <tr>
              <td>${cat.name}</td>
              <td>${cat.transaction_count}</td>
              <td>£${cat.total_amount}</td>
              <td>
                <button class='btn btn-danger btn-sm' onclick="deleteCategory('false', ${cat.id})">Delete</button>
              </td>
            </tr>
          `).join('') :
          '<tr><td colspan="4" class="text-center">No expense categories available</td></tr>';
      }
    }
      
    // 全局变量：存储 budgets
    let budgets = [];

    function loadBudgets() {
      let getBudgetsUrl = 'get-budgets/';
      const getBudgetsUrlMeta = document.querySelector('meta[name="get-budgets-url"]');
      if (getBudgetsUrlMeta) {
        getBudgetsUrl = getBudgetsUrlMeta.getAttribute('content');
      }
      
      fetch(getBudgetsUrl)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            budgets = data.budgets;
            updateBudgetTable();
          } else {
            console.error('Failed to load budgets:', data.message);
          }
        })
        .catch(error => {
          console.error('Error loading budgets:', error);
        });
    }

    function openAddBudgetModal() {
      document.getElementById('budgetYearMonth').value = '';
      document.getElementById('budgetAmount').value = '';
      updateBudgetCategoryDropdown('budgetCategory');
      const addBudgetModal = new bootstrap.Modal(document.getElementById('addBudgetModal'));
      addBudgetModal.show();
    }

    function openEditBudgetModal(budgetId) {
      const budget = budgets.find(b => b.id == budgetId);
      if (!budget) {
        console.error('Budget not found:', budgetId);
        return;
      }
      
      document.getElementById('editBudgetId').value = budget.id;
      document.getElementById('editBudgetYearMonth').value = budget.period;
      document.getElementById('editBudgetAmount').value = budget.budget_amount;
      
      updateBudgetCategoryDropdown('editBudgetCategory');
      
      // 設置選中的類別
      setTimeout(() => {
        document.getElementById('editBudgetCategory').value = budget.category_id;
      }, 100);
      
      const editBudgetModal = new bootstrap.Modal(document.getElementById('editBudgetModal'));
      editBudgetModal.show();
    }

    document.getElementById('saveBudget').addEventListener('click', () => {
      const yearMonth = document.getElementById('budgetYearMonth').value;
      const amount = document.getElementById('budgetAmount').value;
      const categoryEl = document.getElementById('budgetCategory');

      if (!yearMonth) {
        alert('Please select a year-month');
        return;
      }
      if (!amount || isNaN(parseFloat(amount))) {
        alert('Please enter a valid amount');
        return;
      }
      if (!categoryEl.value) {
        alert('Please select a category');
        return;
      }
      
      let addBudgetUrl = 'add-budget/';
      const addBudgetUrlMeta = document.querySelector('meta[name="add-budget-url"]');
      if (addBudgetUrlMeta) {
        addBudgetUrl = addBudgetUrlMeta.getAttribute('content');
      }
      
      fetch(addBudgetUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          'period': yearMonth,
          'category_id': categoryEl.value,
          'budget_amount': amount
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          loadBudgets();
          const addBudgetModal = bootstrap.Modal.getInstance(document.getElementById('addBudgetModal'));
          addBudgetModal.hide();
        } else {
          console.error('Failed to add budget:', data.message);
          alert(`Failed to add budget: ${data.message}`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error adding budget. Please check console.');
      });
    });

    document.getElementById('updateBudget').addEventListener('click', () => {
      const budgetId = document.getElementById('editBudgetId').value;
      const yearMonth = document.getElementById('editBudgetYearMonth').value;
      const amount = document.getElementById('editBudgetAmount').value;
      const categoryEl = document.getElementById('editBudgetCategory');
      
      if (!yearMonth) {
        alert('Please select a year-month');
        return;
      }
      if (!amount || isNaN(parseFloat(amount))) {
        alert('Please enter a valid amount');
        return;
      }
      if (!categoryEl.value) {
        alert('Please select a category');
        return;
      }
      
      let updateBudgetUrl = 'update-budget/';
      const updateBudgetUrlMeta = document.querySelector('meta[name="update-budget-url"]');
      if (updateBudgetUrlMeta) {
        updateBudgetUrl = updateBudgetUrlMeta.getAttribute('content');
      }
      
      fetch(updateBudgetUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          'budget_id': budgetId,
          'period': yearMonth,
          'category_id': categoryEl.value,
          'budget_amount': amount
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          loadBudgets();
          const editBudgetModal = bootstrap.Modal.getInstance(document.getElementById('editBudgetModal'));
          editBudgetModal.hide();
        } else {
          console.error('Failed to update budget:', data.message);
          alert(`Failed to update budget: ${data.message}`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error updating budget. Please check console.');
      });
    });

    function deleteBudget(budgetId) {
      if (!confirm('You are about to delete this budget. Are you sure?')) {
        return;
      }
      
      let deleteBudgetUrl = 'delete-budget/';
      const deleteBudgetUrlMeta = document.querySelector('meta[name="delete-budget-url"]');
      if (deleteBudgetUrlMeta) {
        deleteBudgetUrl = deleteBudgetUrlMeta.getAttribute('content');
      }
      
      fetch(deleteBudgetUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `budget_id=${budgetId}`
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          loadBudgets();
        } else {
          console.error('Failed to delete budget:', data.message);
          alert(`Failed to delete budget: ${data.message}`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error deleting budget. Please check console.');
      });
    }

    function updateBudgetTable() {
      const tableBody = document.getElementById('budget-table');
      if (!tableBody) return;
      tableBody.innerHTML = budgets.length > 0 ?
        budgets.map(budget => `
          <tr>
            <td>${budget.period}</td>
            <td>${budget.category_name}</td>
            <td>£${parseFloat(budget.budget_amount).toFixed(2)}</td>
            <td>£${parseFloat(budget.remaining_amount).toFixed(2)}</td>
            <td>
              <button class="btn btn-warning btn-sm" onclick="openEditBudgetModal(${budget.id})">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteBudget(${budget.id})">Delete</button>
            </td>
          </tr>
        `).join('') :
        '<tr><td colspan="5" class="text-center">No budgets available</td></tr>';
    }

    function calculateRemainingBudget() {
      budgets.forEach(budget => {
        const [year, month] = budget.yearMonth.split('-'); 
        let totalSpent = 0;

        //  calculate total spent for the budget period
        totalSpent = transactions
          .filter(transaction => {
            const transactionDate = new Date(transaction.date);
            return (
              transactionDate.getFullYear() === parseInt(year) &&
              transactionDate.getMonth() + 1 === parseInt(month) && // months are 0-indexed
              transaction.amount.startsWith('-') // only count expenses
            );
          })
          .reduce((sum, transaction) => sum + Math.abs(parseFloat(transaction.amount.replace('£', ''))), 0);

        budget.remainingAmount = budget.amount - totalSpent;
      });

      updateBudgetTable();
    }

    function openAddCurrencyModal() {
      if (document.getElementById('newCurrencyCode')) {
        document.getElementById('newCurrencyCode').value = '';
      }
      if (document.getElementById('exchangeRate')) {
        document.getElementById('exchangeRate').value = '';
      }
      
      const addCurrencyModal = new bootstrap.Modal(document.getElementById('addCurrencyModal'));
      addCurrencyModal.show();
      
      loadAvailableCurrencies();
    }

    function openAddAccountModal() {
      const addAccountModal = new bootstrap.Modal(document.getElementById('addAccountModal'));
      addAccountModal.show();
    }
      

    // 在 DOMContentLoaded 事件內添加這些
    document.getElementById('addType').addEventListener('change', function() {
      updateCategoryDropdown();
    });

    document.getElementById('editType').addEventListener('change', function() {
      updateEditCategoryDropdown(this.value);
    });

    function deleteCategory(is_income, categoryId) {
      console.log('Deleting category:', categoryId);
      if (!confirm('Are you sure you want to delete this category?')) {
        return;
      }

      let deleteUrl = 'delete-category/';
      const urlMeta = document.querySelector('meta[name="delete-category-url"]');
      if (urlMeta) {
        deleteUrl = urlMeta.getAttribute('content');
      }
      console.log('Delete URL:', deleteUrl);

      fetch(deleteUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `category_id=${categoryId}`
      })
      .then(response => {
        console.log('HTTP response status:', response.status);
        return response.text();
      })
      .then(text => {
        console.log('Response text:', text);
        // try analyzing JSON, if failed, return original text
        try {
          return JSON.parse(text);
        } catch (e) {
          console.error('Failed to parse JSON:', e);
          return { status: 'error', message: 'Invalid JSON response: ' + text };
        }
      })
      .then(data => {
        console.log('Parsed data:', data);
        if (data.status === 'success') {
          window.categories[is_income] = categories[is_income].filter(c => c.id !== categoryId);
          updateCategoryTables();
          updateCategoryDropdown();
          console.log('Category deleted successfully:', data.message);
        } else {
          console.error('Failed to delete:', data.message);
          alert(`Failed to delete: ${data.message}`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the category. Please check console.');
      });
    }

    function openAddIncomeCategoryModal() {
      document.getElementById('incomeCategoryName').value = ''; // Clear the input box
      const addIncomeCategoryModal = new bootstrap.Modal(document.getElementById('addIncomeCategoryModal'));
      addIncomeCategoryModal.show();
    }

    function openAddExpenseCategoryModal() {
      document.getElementById('expenseCategoryName').value = ''; // Clear the input box
      const addExpenseCategoryModal = new bootstrap.Modal(document.getElementById('addExpenseCategoryModal'));
      addExpenseCategoryModal.show();
    }

    document.getElementById('saveIncomeCategory').addEventListener('click', () => {
      const categoryName = document.getElementById('incomeCategoryName').value;

      let addCategoryUrl = 'add-category/';
      const addCategoryUrlMeta = document.querySelector('meta[name="add-category-url"]');
      if (addCategoryUrlMeta) {
        addCategoryUrl = addCategoryUrlMeta.getAttribute('content');
      }

      document.getElementById('saveIncomeCategory').blur();
      const modal = bootstrap.Modal.getInstance(document.getElementById('addIncomeCategoryModal'));
      modal.hide();

      fetch(addCategoryUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          'name': categoryName,
          'is_income': 'true'
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          window.categories['true'].push({
            id: data.id || Date.now(), // 如果後端沒有返回ID，使用時間戳作為臨時ID
            name: data.name || categoryName,
            transaction_count: 0,
            total_amount: "0.00"
          });
          updateCategoryTables();
          updateCategoryDropdown();
        } else if(data.status === 'exists'){
            alert("Category already exists");          
        }else {
          alert(data.message);
        }
      })
      .catch(error => {
        console.error('Error details:', error);
        alert('Error when adding income category: ' + error.message);
      });
    });

    document.getElementById('saveExpenseCategory').addEventListener('click', () => {
      const categoryName = document.getElementById('expenseCategoryName').value;

      let addCategoryUrl = 'add-category/';
      const addCategoryUrlMeta = document.querySelector('meta[name="add-category-url"]');
      if (addCategoryUrlMeta) {
        addCategoryUrl = addCategoryUrlMeta.getAttribute('content');
      }

      document.getElementById('saveExpenseCategory').blur();
      const modal = bootstrap.Modal.getInstance(document.getElementById('addExpenseCategoryModal'));
      modal.hide();

      fetch(addCategoryUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          'name': categoryName,
          'is_income': 'false'
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          window.categories['false'].push({
            id: data.id || Date.now(), // 如果後端沒有返回ID，使用時間戳作為臨時ID
            name: data.name || categoryName,
            transaction_count: 0,
            total_amount: "0.00"
          });
          updateCategoryTables();
          updateCategoryDropdown();
        } else if(data.status === 'exists'){
            alert("Category already exists");          
        }else {
          alert(data.message);
        }
      })
      .catch(error => {
        alert('Error when adding expense category');
      });
    });

    // get available currencies
    function loadAvailableCurrencies() {
      let getAvailableCurrenciesUrl = '/get-available-currencies/';
      const getAvailableCurrenciesUrlMeta = document.querySelector('meta[name="get-available-currencies-url"]');
      if (getAvailableCurrenciesUrlMeta) {
        getAvailableCurrenciesUrl = getAvailableCurrenciesUrlMeta.getAttribute('content');
      }
      
      fetch(getAvailableCurrenciesUrl, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          updateCurrencyDropdown(data.currencies);
        } else {
          console.error('Failed to load available currencies:', data.message);
        }
      })
      .catch(error => {
        console.error('Error loading available currencies:', error);
      });
    }

    // Update currency dropdown
    function updateCurrencyDropdown(currencies) {
      const currencySelect = document.getElementById('currencySelect');
      if (!currencySelect) return;
      
      if (!currencies || !Array.isArray(currencies)) {
        console.error('Invalid currencies data:', currencies);
        currencies = [];
      }
      
      currencySelect.innerHTML = '<option value="">-- Select Currency --</option>';
      
      const systemOptions = document.createElement('optgroup');
      systemOptions.label = 'System Currencies';
      
      const userOptions = document.createElement('optgroup');
      userOptions.label = 'Your Currencies';
      
      currencies.forEach(currency => {
        const option = document.createElement('option');
        option.value = currency.id;
        option.textContent = currency.currency_code;
        option.dataset.exchangeRate = currency.exchange_rate;
        
        if (currency.user) {
          userOptions.appendChild(option);
        } else {
          systemOptions.appendChild(option);
        }
      });
      
      if (systemOptions.children.length > 0) {
        currencySelect.appendChild(systemOptions);
      }
      if (userOptions.children.length > 0) {
        currencySelect.appendChild(userOptions);
      }
    }

    // Monitor currency change event
    document.getElementById('currencySelect').addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      if (selectedOption && selectedOption.dataset.exchangeRate) {
        document.getElementById('exchangeRate').value = selectedOption.dataset.exchangeRate;
        document.getElementById('newCurrencyCode').value = '';
      }
    });

    function loadCurrencies() {
      let getCurrenciesUrl = '/get-currencies/';
      const getCurrenciesUrlMeta = document.querySelector('meta[name="get-currencies-url"]');
      if (getCurrenciesUrlMeta) {
        getCurrenciesUrl = getCurrenciesUrlMeta.getAttribute('content');
      }
      
      fetch(getCurrenciesUrl)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            updateCurrencyTable(data.currencies);
          } else {
            console.error('Failed to load currencies:', data.message);
          }
        })
        .catch(error => {
          console.error('Error loading currencies:', error);
        });
    }

    function updateCurrencyTable(currencies) {
      console.log('Updating currency table with data:', currencies);
      const currencyTable = document.getElementById('currency-table');
  
      if (!currencyTable) {
        console.error('Currency table element not found');
        return;
      }
      
      if (currencies && currencies.length > 0) {
        let tableContent = '';
        currencies.forEach(currency => {
          let lastUpdated = 'N/A';
          try {
            lastUpdated = new Date(currency.last_updated).toLocaleString();
          } catch (e) {
            console.error('Error formatting date:', e);
          }
          
          tableContent += `
            <tr>
              <td>${currency.currency_code}</td>
              <td>${currency.exchange_rate}</td>
              <td>${lastUpdated}</td>
              <td>
                <button class="btn btn-danger btn-sm" onclick="deleteCurrency(${currency.id})">Delete</button>
              </td>
            </tr>
          `;
        });
        currencyTable.innerHTML = tableContent;
        console.log('Currency table updated with', currencies.length, 'items');
      } else {
        currencyTable.innerHTML = '<tr><td colspan="4" class="text-center">No currency available</td></tr>';
        console.log('No currencies available, showing empty message');
      }
    }

    document.getElementById('saveCurrency').addEventListener('click', () => {
      const selectedCurrency = document.getElementById('currency').value;
      const newCurrencyCode = document.getElementById('newCurrencyCode').value.trim();
      const exchangeRate = document.getElementById('exchangeRate').value;

      if (!selectedCurrency && !newCurrencyCode) {
        alert('Please select a currency or enter a new currency code');
        return;
      }
      
      if (!exchangeRate) {
        alert('Please enter an exchange rate');
        return;
      }

      let addCurrencyUrl = 'add-currency/';
      const addCurrencyUrlMeta = document.querySelector('meta[name="add-currency-url"]');
      if (addCurrencyUrlMeta) {
        addCurrencyUrl = addCurrencyUrlMeta.getAttribute('content');
      }

      document.getElementById('saveCurrency').blur();
      const modal = bootstrap.Modal.getInstance(document.getElementById('addCurrencyModal'));
      modal.hide();

      fetch(addCurrencyUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          'currency_id': selectedCurrency,
          'currency_code': newCurrencyCode,
          'exchange_rate': exchangeRate,
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          loadCurrencies();
          // window.location.reload();
        } else if(data.status === 'exists') {
          alert("Currency already exists");          
        } else {
          alert(data.message);
        }
      })
      .catch(error => {
        alert('Error when adding currency');
      });
    });

    function deleteCurrency(id) {
      const deleteCurrencyUrl = 'delete-currency/';
      const deleteCurrencyUrlMeta = document.querySelector('meta[name="delete-currency-url"]');
      if (deleteCurrencyUrlMeta) {
        deleteCurrencyUrl = deleteCurrencyUrlMeta.getAttribute('content');
      }

      fetch(deleteCurrencyUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `currency_id=${currencyId}`
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          window.currencies = window.currencies.filter(c => c.id !== id);
          updateCategoryTables();
        } else {
          alert(data.message);
        }
      })
      .catch(error => {
        alert('Error when deleting currency');
      });
    }

    function loadAccounts() {
      let getAccountsUrl = 'get-accounts/';
      const getAccountsUrlMeta = document.querySelector('meta[name="get-accounts-url"]');
      if (getAccountsUrlMeta) {
        getAccountsUrl = getAccountsUrlMeta.getAttribute('content');
      }
      
      fetch(getAccountsUrl)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success' && data.accounts && Array.isArray(data.accounts)) {
            console.log('Successfully loaded accounts from API:', data.accounts.length);
            if (data.accounts.length > 0) {
              window.accounts = data.accounts;
              updateAccountTable();
            } else {
              console.warn('API returned empty accounts array, keeping current data');
            }
          } else {
            console.error('Failed to load accounts:', data);
          }
        })
        .catch(error => {
          console.error('Error loading accounts:', error);
        });
    }

    function updateAccountTable() {
      const accountTable = document.getElementById('account-table');
      if (!accountTable) {
        console.error('Account table element not found');
        return;
      }
      
      if (!window.accounts || !Array.isArray(window.accounts)) {
        console.error('Accounts not defined or not an array:', window.accounts);
        return;
      }
      
      console.log('Updating account table with', window.accounts.length, 'accounts');
      
      if (window.accounts.length > 0) {
        let tableContent = '';
        window.accounts.forEach((account, index) => {
          tableContent += `
            <tr data-account-id="${account.id}" data-index="${index}">
              <td>${account.account_name}</td>
              <td>${account.account_type}</td>
              <td>£${account.balance}</td>
              <td>
                <button class="btn btn-danger btn-sm" onclick="deleteAccount(${account.id})">Delete</button>
                <span class="drag-handle"><i class="bi bi-list"></i></span>
              </td>
            </tr>
          `;
        });
        accountTable.innerHTML = tableContent;
      
        // initialize drag functionality
        initDragAndDrop();
      } else {
        accountTable.innerHTML = '<tr><td colspan="4" class="text-center">No accounts available</td></tr>';
      }
    }

    function initDragAndDrop() {
      const table = document.getElementById('account-table');
      const rows = table.querySelectorAll('tr[data-account-id]');
      let draggedRow = null;
      
      // Add event listeners to each row
      rows.forEach(row => {
        const handle = row.querySelector('.drag-handle');
        
        if (!handle) return;
        
        // ensure only draggable when handle is clicked
        handle.addEventListener('mousedown', () => {
          row.setAttribute('draggable', 'true');
        });
        
        row.addEventListener('mouseup', () => {
          row.setAttribute('draggable', 'false');
        });
        
        row.addEventListener('dragstart', (e) => {
          draggedRow = row;
          row.classList.add('dragging');
          
          // 為了解決Firefox拖曳問題
          e.dataTransfer.setData('text/plain', '');
        });
        
        row.addEventListener('dragend', () => {
          row.classList.remove('dragging');
          draggedRow = null;
          
          rows.forEach(r => r.classList.remove('drop-target'));
        });
        
        row.addEventListener('dragover', (e) => {
          e.preventDefault();
          if (!draggedRow || row === draggedRow) return;
          
          // add drop-target class to row
          rows.forEach(r => r.classList.remove('drop-target'));
          row.classList.add('drop-target');
        });
        
        row.addEventListener('drop', (e) => {
          e.preventDefault();
          if (!draggedRow || row === draggedRow) return;
          
          // 獲取行索引
          const fromIndex = parseInt(draggedRow.getAttribute('data-index'));
          const toIndex = parseInt(row.getAttribute('data-index'));
          
          // 重新排序 accounts 數組
          const movedAccount = window.accounts.splice(fromIndex, 1)[0];
          window.accounts.splice(toIndex, 0, movedAccount);
          
          // 更新表格顯示
          updateAccountTable();
          
          // 直接保存排序到後端，不顯示保存按鈕
          saveAccountOrderToBackend();
        });
      });
      
      // 保存順序按鈕事件
      const saveButton = document.getElementById('saveAccountOrder');
      if (saveButton) {
        // 移除舊的事件監聽器
        const newSaveButton = saveButton.cloneNode(true);
        saveButton.parentNode.replaceChild(newSaveButton, saveButton);
        
        // 添加新的事件監聽器
        newSaveButton.addEventListener('click', saveAccountOrder);
      }
    }
    
    function saveAccountOrderToBackend() {
      const accountIds = window.accounts.map(a => a.id);

      let orderAccountUrl = 'order-accounts/';
      const orderAccountUrlMeta = document.querySelector('meta[name="order-accounts-url"]');
      if (orderAccountUrlMeta) {
        orderAccountUrl = orderAccountUrlMeta.getAttribute('content');
      }
      
      // 使用 fetch API 發送排序數據到後端
      fetch(orderAccountUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          account_ids: accountIds
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status !== 'success') {
          console.error('Failed to save account order:', data.message);
          alert('Failed to order: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error saving account order:', error);
      });
    }

    document.getElementById('saveAccount').addEventListener('click', () => {
      const accountName = document.getElementById('accountName').value;
      const accountType = document.getElementById('addAccount').value;
      const balance = document.getElementById('addBalance').value;

      let addAccountUrl = 'add-account/';
      const addAccountUrlMeta = document.querySelector('meta[name="add-account-url"]');
      if (addAccountUrlMeta) {
        addAccountUrl = addAccountUrlMeta.getAttribute('content');
      }

      document.getElementById('saveAccount').blur();
      const modal = bootstrap.Modal.getInstance(document.getElementById('addAccountModal'));
      modal.hide();

      fetch(addAccountUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          'account_name': accountName,
          'account_type': accountType,
          'balance': balance,
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          loadAccounts();
        } else if(data.status === 'exists'){
            alert("Account already exists");          
        }else {
          alert(data.message);
        }
      })
      .catch(error => {
        console.error('Error when adding account:', error);
        alert('Error when adding account' + error);
      });
    })

    function deleteAccount(account_id) {
      if (!confirm('You are about to delete this budget. Are you sure?')) {
        return;
      }

      let deleteAccountUrl = 'delete-account/';
      const deleteAccountUrlMeta = document.querySelector('meta[name="delete-account-url"]');
      if (deleteAccountUrlMeta) {
        deleteAccountUrl = deleteAccountUrlMeta.getAttribute('content');
      }

      fetch(deleteAccountUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `account_id=${account_id}`
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          loadAccounts();
        } else {
          alert(data.message);
        }
      })
      .catch(error => {
        alert('Error when deleting account:' + error);
      });
    }

    function exportToCSV() {
      const headers = ["Date", "Categories", "Pending", "Description"];
      const csvContent = "data:text/csv;charset=utf-8," 
          + headers.join(",") + "\n" 
          + transactions.map(t => 
              `${t.date},${t.category},${t.amount},${t.description}`
          ).join("\n");

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "transactions.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Initialize data
    function initializeData() {
      // 初始化交易數據
      const transactionsDataElement = document.getElementById('transactions_data');
      if (transactionsDataElement) {
        try {
          window.transactions = JSON.parse(transactionsDataElement.textContent);
        } catch (e) {
          console.error('Failed to parse transactions data:', e);
          window.transactions = [];
        }
      }

      if (!window.accounts) {
        const accountsDataElement = document.getElementById('accounts_data');
        if(accountsDataElement){
          try {
            window.accounts = JSON.parse(accountsDataElement.textContent);
            console.log('Successfully parsed accounts:', window.accounts);
            console.log('Accounts data type:', typeof window.accounts);
            console.log('Is array?', Array.isArray(window.accounts));
            if (Array.isArray(window.accounts)) {
              console.log('Accounts length:', window.accounts.length);
              console.log('First account sample:', window.accounts.length > 0 ? JSON.stringify(window.accounts[0]) : 'none');
            }
          } catch (e) {
            console.error('Failed to parse accounts data:', e);
            window.accounts = [];
          }
        } else {
          console.warn('Accounts data element not found, initializing empty accounts');
          window.accounts = [];
        }
      }
      
      // 只有在尚未設置 window.categories 時才初始化類別數據
      if (!window.categories) {
        const categoriesDataElement = document.getElementById('categories_data');
        if (categoriesDataElement) {
          try {
            window.categories = JSON.parse(categoriesDataElement.textContent);
            console.log('Successfully parsed categories:', window.categories);
          } catch (e) {
            console.error('Failed to parse categories data:', e);
            window.categories = {'true': [], 'false': []};
          }
        } else {
          console.warn('Categories data element not found, initializing empty categories');
          window.categories = {'true': [], 'false': []};
        }
      }
      
      // 確保類別結構完整
      if (!window.categories) {
        console.warn('Categories still not defined after initialization, creating empty object');
        window.categories = {};
      }
      
      if (!window.categories['true']) {
        console.warn('true category array not found, initializing empty array');
        window.categories['true'] = [];
      }
      
      if (!window.categories['false']) {
        console.warn('false category array not found, initializing empty array');
        window.categories['false'] = [];
      }
      
      console.log('Final categories structure:', window.categories);
    }

    document.addEventListener("DOMContentLoaded", () => {
      initializeData();
      console.log('After initialization, accounts:', window.accounts);
      const accountTable = document.getElementById('account-table');
      if (accountTable) {
        console.log('Account table found, updating with current data');
        updateAccountTable();
        console.log("HI")
      }

      const tabLinks = document.querySelectorAll('a[data-bs-toggle="tab"]');
  
      tabLinks.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
          if (event.target.getAttribute('href') === '#by-month' || event.target.getAttribute('href') === '#by-saved') {
            currentFilterState.category = 'all';
            currentFilterState.transactionType = 'all';
            
            document.querySelectorAll('.btn-secondary, .btn-success, .btn-danger').forEach(btn => {
              btn.classList.remove('active');
            });
            document.querySelector('.btn-secondary').classList.add('active');
            
            if (document.getElementById('category-filter')) {
              document.getElementById('category-filter').value = 'all';
            }
            
            refreshTables();
          }
        });
      });

      if(document.getElementById('detail-page')){
        refreshTables();
        filterCategory();
        updateCategoryDropdown(); // Refresh drop-down box
        updateAccountDropdown();
      }
      
      if(document.getElementById('management-page')){
        updateCategoryTables(); // Initialize Management Table
      }

      if (document.getElementById('budget-table')) {
        loadBudgets();
      }

      if(document.getElementById('currency-table')){
        console.log('Loading currencies for table...');
        loadCurrencies();
      }

      if (document.getElementById('currency')) {
        loadAvailableCurrencies();
      }

      if (document.getElementById('account-table')) {
        loadAccounts();
      }

      // Other general initialization
      calculateRemainingBudget();
      // document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tabEl => {
      //   tabEl.addEventListener('shown.bs.tab', function (event) {
      //     const targetHref = event.target.getAttribute('href');
      //     if (targetHref === '#currency') {
      //       console.log('Currency tab activated, loading currencies...');
      //       loadCurrencies();
      //     }
      //   });
      // });
    });
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>