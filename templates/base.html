{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Wallet Notes{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    .sidebar {
      height: 100vh;
      background: #343a40;
      color: white;
      padding: 20px;
    }
    .sidebar a {
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      padding: 10px;
    }
    .sidebar a:hover {
      background: #495057;
    }
    .active {
      background: #6c757d !important;
    }
    .sidebar-logo {
      width: 20px;
      height: 20px;
      margin-right: 10px;
    }
    .logout-btn {
      position: absolute;  
      bottom: 20px;
      left: 20px;
      color: white;
      text-decoration: none;
      padding: 10px;
      display: flex;
      align-items: center;
    }
    .logout-btn:hover {
      color: #ff4444;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Side Bar -->
      <nav class="col-md-2 d-md-block sidebar">
        <h4>Wallet Notes</h4>
        <a href="{% url 'detail' %}" id="detail-link" class="{% block active_detail %}{% endblock %}">
          <img src="{% static 'img/detail.png' %}" alt="Detail Logo" class="sidebar-logo">
          Detail
        </a>
        <a href="{% url 'statistics' %}" id="statistics-link" class="{% block active_statistics %}{% endblock %}">
          <img src="{% static 'img/statistics.png' %}" alt="Statistics Logo" class="sidebar-logo">
          Statistics
        </a>
        <a href="{% url 'management' %}" id="management-link" class="{% block active_management %}{% endblock %}">
          <img src="{% static 'img/management.png' %}" alt="Management Logo" class="sidebar-logo">
          Management
        </a>
        <a href="{% url 'logout' %}" class="logout-btn">
          <i class="bi bi-box-arrow-left"></i>&nbsp;&nbsp;Logout
        </a>
      </nav>
      
      <!-- Main Content -->
      <main class="col-md-10 p-4">
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>
  
  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">Edit Transaction</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <div class="mb-3">
              <label for="editDate" class="form-label">Date</label>
              <input type="text" class="form-control" id="editDate" required>
            </div>
            <div class="mb-3">
              <label for="editCategory" class="form-label">Category</label>
              <select class="form-select" id="editCategory">
                <option value="food">Food</option>
                <option value="shopping">Shopping</option>
                <option value="transportation">Transportation</option>
                <option value="education">Education</option>
                <option value="entertainment">Entertainment</option>
                <option value="housing">Housing</option>
                <option value="medical">Medical</option>
                <option value="investment">Investment</option>
                <option value="others">Others</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editAmount" class="form-label">Amount</label>
              <input type="text" class="form-control" id="editAmount" required>
            </div>
            <div class="mb-3">
              <label for="editDescription" class="form-label">Description</label>
              <input type="text" class="form-control" id="editDescription">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveChanges">Save changes</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Modal -->
  <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addModalLabel">Add Transaction</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addForm">
            <div class="mb-3">
              <label for="addDate" class="form-label">Date</label>
              <input type="text" class="form-control" id="addDate" required>
            </div>
            <div class="mb-3">
              <label for="addCategory" class="form-label">Category</label>
              <select id="addCategory" class="form-control" required>
                <!-- Categories will be dynamically populated here -->
              </select>
            </div>
            <div class="mb-3">
              <label for="addAmount" class="form-label">Amount</label>
              <input type="text" class="form-control" id="addAmount" required>
            </div>
            <div class="mb-3">
              <label for="addDescription" class="form-label">Description</label>
              <input type="text" class="form-control" id="addDescription">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="addTransaction">Add</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Income Category Modal -->
  <div class="modal fade" id="addIncomeCategoryModal" tabindex="-1" aria-labelledby="addIncomeCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addIncomeCategoryModalLabel">Add Income Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addIncomeCategoryForm">
            <div class="mb-3">
              <label for="incomeCategoryName" class="form-label">Name</label>
              <input type="text" class="form-control" id="incomeCategoryName" required>
            </div>
            <div class="mb-3">
              <label for="incomeCategoryType" class="form-label">Type</label>
              <input type="text" class="form-control" id="incomeCategoryType" value="Income" readonly>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveIncomeCategory">Save</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Outcome Category Modal -->
  <div class="modal fade" id="addOutcomeCategoryModal" tabindex="-1" aria-labelledby="addOutcomeCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addOutcomeCategoryModalLabel">Add Outcome Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addOutcomeCategoryForm">
            <div class="mb-3">
              <label for="outcomeCategoryName" class="form-label">Name</label>
              <input type="text" class="form-control" id="outcomeCategoryName" required>
            </div>
            <div class="mb-3">
              <label for="outcomeCategoryType" class="form-label">Type</label>
              <input type="text" class="form-control" id="outcomeCategoryType" value="Outcome" readonly>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveOutcomeCategory">Save</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Recurring Transaction Modal -->
  <div class="modal fade" id="addRecurringTransactionModal" tabindex="-1" aria-labelledby="addRecurringTransactionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addRecurringTransactionModalLabel">Add Recurring Transaction</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addRecurringTransactionForm">
            <div class="mb-3">
              <label for="recurringDay" class="form-label">Day of Month (1-31)</label>
              <input type="number" class="form-control" id="recurringDay" min="1" max="31" required>
            </div>
            <div class="mb-3">
              <label for="recurringType" class="form-label">Type</label>
              <select class="form-control" id="recurringType" required>
                <option value="income">Income</option>
                <option value="outcome">Outcome</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="recurringAmount" class="form-label">Budget Amount</label>
              <input type="number" class="form-control" id="recurringAmount" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveRecurringTransaction">Save</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Budget Modal -->
  <div class="modal fade" id="addBudgetModal" tabindex="-1" aria-labelledby="addBudgetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addBudgetModalLabel">Add Budget</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addBudgetForm">
            <div class="mb-3">
              <label for="budgetYearMonth" class="form-label">Year-Month</label>
              <input type="month" class="form-control" id="budgetYearMonth" required>
            </div>
            <div class="mb-3">
              <label for="budgetAmount" class="form-label">Budget Amount</label>
              <input type="number" class="form-control" id="budgetAmount" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveBudget">Save</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let currentEditIndex = null;

    function filterTransactions(type) {
      document.querySelectorAll('.btn-secondary, .btn-success, .btn-danger').forEach(btn => {
        btn.classList.remove('active');
      });
      if (type === 'all') {
        document.querySelector('.btn-secondary').classList.add('active');
      } else if (type === 'in') {
        document.querySelector('.btn-success').classList.add('active');
      } else if (type === 'out') {
        document.querySelector('.btn-danger').classList.add('active');
      }

      let filtered = transactions;
      if (type === 'in') {
        filtered = transactions.filter(t => t.amount.includes('+'));
      } else if (type === 'out') {
        filtered = transactions.filter(t => t.amount.includes('-'));
      }
    }

    function filterCategory() {
      const selectedCategory = document.getElementById('category-filter').value;
      let filtered = transactions;

      if (selectedCategory !== 'all') {
        filtered = transactions.filter(t => t.category === selectedCategory);
      }

      const activeFilter = document.querySelector('.btn-secondary.active, .btn-success.active, .btn-danger.active')?.getAttribute('data-filter') || 'all';
      if (activeFilter === 'in') {
        filtered = filtered.filter(t => t.amount.includes('+'));
      } else if (activeFilter === 'out') {
        filtered = filtered.filter(t => t.amount.includes('-'));
      }
    }

    function openEditModal(index) {
      const transaction = transactions[index];
      currentEditIndex = index;

      document.getElementById('editDate').value = transaction.date;
      document.getElementById('editCategory').value = transaction.category;
      document.getElementById('editAmount').value = transaction.amount;
      document.getElementById('editDescription').value = transaction.description;
      console.log("11111111111111111 " + document.getElementById('editAmount').value);

      const editModal = new bootstrap.Modal(document.getElementById('editModal'));
      editModal.show();
    }

    function openAddModal() {
      const addModal = new bootstrap.Modal(document.getElementById('addModal'));
      addModal.show();
      updateCategoryDropdown(); // Update drop-down box
    }

    function deleteTransaction(index) {
      transactions.splice(index, 1);
      filterTransactions('all'); // Refresh table
    }
      
    // 全局变量：存储 recurring transactions
    let recurringTransactions = [];

    // 打开新增弹窗
    function openAddRecurringTransactionModal() {
      document.getElementById('recurringDay').value = '';
      document.getElementById('recurringType').value = 'income';
      document.getElementById('recurringAmount').value = '';
      const addRecurringTransactionModal = new bootstrap.Modal(document.getElementById('addRecurringTransactionModal'));
      addRecurringTransactionModal.show();
    }

    // 保存新增的 recurring transaction
    document.getElementById('saveRecurringTransaction').addEventListener('click', () => {
      const day = document.getElementById('recurringDay').value;
      const type = document.getElementById('recurringType').value;
      const amount = document.getElementById('recurringAmount').value;

      if (day && type && amount) {
        const newTransaction = {
          id: Date.now(), // 使用时间戳作为唯一 ID
          day: parseInt(day),
          type: type,
          amount: parseFloat(amount)
        };
        recurringTransactions.push(newTransaction);
        updateRecurringTransactionsTable(); // 更新表格
        const addRecurringTransactionModal = bootstrap.Modal.getInstance(document.getElementById('addRecurringTransactionModal'));
        addRecurringTransactionModal.hide();
      }
    });

    // 删除 recurring transaction
    function deleteRecurringTransaction(id) {
      recurringTransactions = recurringTransactions.filter(transaction => transaction.id !== id);
      updateRecurringTransactionsTable(); // 更新表格
    }

    // 更新 recurring transactions 表格
    function updateRecurringTransactionsTable() {
      const tableBody = document.getElementById('recurring-transactions-table');
      tableBody.innerHTML = recurringTransactions.map(transaction => `
        <tr>
          <td>${transaction.day}</td>
          <td>${transaction.type}</td>
          <td>£${transaction.amount.toFixed(2)}</td>
          <td>
            <button class="btn btn-danger btn-sm" onclick="deleteRecurringTransaction(${transaction.id})">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    // 初始化页面时更新表格
    document.addEventListener("DOMContentLoaded", () => {
      updateRecurringTransactionsTable();
    });


    document.getElementById('saveChanges').addEventListener('click', () => {
      if (currentEditIndex !== null) {
        transactions[currentEditIndex] = {
          date: document.getElementById('editDate').value,
          category: document.getElementById('editCategory').value,
          amount: document.getElementById('editAmount').value,
          description: document.getElementById('editDescription').value
        };
        filterTransactions('all'); // 刷新表格
        const editModal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
        editModal.hide();
      }
    });

    document.getElementById('addTransaction').addEventListener('click', () => {
      const newTransaction = {
        date: document.getElementById('addDate').value,
        category: document.getElementById('addCategory').value,
        amount: document.getElementById('addAmount').value,
        description: document.getElementById('addDescription').value
      };
      transactions.push(newTransaction);
      filterTransactions('all'); // 刷新表格
      const addModal = bootstrap.Modal.getInstance(document.getElementById('addModal'));
      addModal.hide();
    });

    function exportToCSV() {
      const headers = ["Date", "Categories", "Pending", "Description"];
      const csvContent = "data:text/csv;charset=utf-8," 
          + headers.join(",") + "\n" 
          + transactions.map(t => 
              `${t.date},${t.category},${t.amount},${t.description}`
          ).join("\n");

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "transactions.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // 更新下拉框
    function updateCategoryDropdown() {
      const categoryDropdown = document.getElementById('addCategory');
      const selectedType = document.getElementById('addType').value;
      categoryDropdown.innerHTML = '';
      categories[selectedType].forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryDropdown.appendChild(option);
      });
    }

    // 更新 Management 页面的类别表格
    function updateManagementTables() {
      const incomeTable = document.getElementById('income-categories-table');
      const outcomeTable = document.getElementById('outcome-categories-table');

      // 更新 Income Categories 表格
      incomeTable.innerHTML = categories.income.map(category => `
        <tr>
          <td>${category}</td>
          <td>Income</td>
          <td><button class='btn btn-danger btn-sm' onclick="deleteCategory('income', '${category}')">Delete</button></td>
        </tr>
      `).join('');

      // 更新 Outcome Categories 表格
      outcomeTable.innerHTML = categories.outcome.map(category => `
        <tr>
          <td>${category}</td>
          <td>Outcome</td>
          <td><button class='btn btn-danger btn-sm' onclick="deleteCategory('outcome', '${category}')">Delete</button></td>
        </tr>
      `).join('');
    }
      
    // 全局变量：存储 budgets
    let budgets = [];

    // 打开新增弹窗
    function openAddBudgetModal() {
      document.getElementById('budgetYearMonth').value = '';
      document.getElementById('budgetAmount').value = '';
      const addBudgetModal = new bootstrap.Modal(document.getElementById('addBudgetModal'));
      addBudgetModal.show();
    }

    // 保存新增的 budget
    document.getElementById('saveBudget').addEventListener('click', () => {
      const yearMonth = document.getElementById('budgetYearMonth').value;
      const amount = document.getElementById('budgetAmount').value;

      if (yearMonth && amount) {
        const newBudget = {
          id: Date.now(), // 使用时间戳作为唯一 ID
          yearMonth: yearMonth,
          amount: parseFloat(amount),
          remainingAmount: parseFloat(amount) // 初始剩余额度等于预算金额
        };
        budgets.push(newBudget);
        updateBudgetTable(); // 更新表格
        const addBudgetModal = bootstrap.Modal.getInstance(document.getElementById('addBudgetModal'));
        addBudgetModal.hide();
      }
    });

    // 删除 budget
    function deleteBudget(id) {
      budgets = budgets.filter(budget => budget.id !== id);
      updateBudgetTable(); // 更新表格
    }

    // 更新 budget 表格
    function updateBudgetTable() {
      const tableBody = document.getElementById('budget-table');
      tableBody.innerHTML = budgets.map(budget => `
        <tr>
          <td>${budget.yearMonth}</td>
          <td>£${budget.amount.toFixed(2)}</td>
          <td>£${budget.remainingAmount.toFixed(2)}</td>
          <td>
            <button class="btn btn-danger btn-sm" onclick="deleteBudget(${budget.id})">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    // 计算预算剩余额度
    function calculateRemainingBudget() {
      budgets.forEach(budget => {
        const [year, month] = budget.yearMonth.split('-'); // 解析年份和月份
        let totalSpent = 0;

        // 计算指定年份和月份的支出
        totalSpent = transactions
          .filter(transaction => {
            const transactionDate = new Date(transaction.date);
            return (
              transactionDate.getFullYear() === parseInt(year) &&
              transactionDate.getMonth() + 1 === parseInt(month) && // 月份从 0 开始，需要 +1
              transaction.amount.startsWith('-') // 只计算支出
            );
          })
          .reduce((sum, transaction) => sum + Math.abs(parseFloat(transaction.amount.replace('£', ''))), 0);

        // 更新剩余额度
        budget.remainingAmount = budget.amount - totalSpent;
      });

      updateBudgetTable(); // 更新表格
    }

    // 初始化页面时更新表格
    document.addEventListener("DOMContentLoaded", () => {
      updateBudgetTable();
      calculateRemainingBudget(); // 初始化时计算剩余额度
    });

    // 在每次新增 transaction 时调用 calculateRemainingBudget
    document.getElementById('addTransaction').addEventListener('click', () => {
      calculateRemainingBudget();
    });

    // 删除类别
    function deleteCategory(type, category) {
      categories[type] = categories[type].filter(c => c !== category);
      updateManagementTables(); // 更新 Management 页面的表格
      updateCategoryDropdown(); // 更新 Detail 页面的下拉框
    }

    function openAddIncomeCategoryModal() {
      document.getElementById('incomeCategoryName').value = ''; // 清空输入框
      const addIncomeCategoryModal = new bootstrap.Modal(document.getElementById('addIncomeCategoryModal'));
      addIncomeCategoryModal.show();
    }

    function openAddOutcomeCategoryModal() {
      document.getElementById('outcomeCategoryName').value = ''; // 清空输入框
      const addOutcomeCategoryModal = new bootstrap.Modal(document.getElementById('addOutcomeCategoryModal'));
      addOutcomeCategoryModal.show();
    }

    // 添加收入类别
    document.getElementById('saveIncomeCategory').addEventListener('click', () => {
      const categoryName = document.getElementById('incomeCategoryName').value;
      if (categoryName && !categories.income.includes(categoryName)) {
        categories.income.push(categoryName);
        updateManagementTables(); // 更新 Management 页面的表格
        updateCategoryDropdown(); // 更新 Detail 页面的下拉框
        const addIncomeCategoryModal = bootstrap.Modal.getInstance(document.getElementById('addIncomeCategoryModal'));
        addIncomeCategoryModal.hide();
      }
    });

    // 添加支出类别
    document.getElementById('saveOutcomeCategory').addEventListener('click', () => {
      const categoryName = document.getElementById('outcomeCategoryName').value;
      if (categoryName && !categories.outcome.includes(categoryName)) {
        categories.outcome.push(categoryName);
        updateManagementTables(); // 更新 Management 页面的表格
        updateCategoryDropdown(); // 更新 Detail 页面的下拉框
        const addOutcomeCategoryModal = bootstrap.Modal.getInstance(document.getElementById('addOutcomeCategoryModal'));
        addOutcomeCategoryModal.hide();
      }
    });

    // 切换页面功能（原有动态切换代码，若分为独立页面可视需求调整）
    document.getElementById('detail-link').addEventListener('click', () => {
      document.getElementById('detail-page').style.display = 'block';
      document.getElementById('statistics-page').style.display = 'none';
      document.getElementById('management-page').style.display = 'none';
      // 移除所有导航项的 active 类
      document.querySelectorAll('.sidebar a').forEach(link => link.classList.remove('active'));
      // 为当前选中的导航项添加 active 类
      document.getElementById('detail-link').classList.add('active');
    });

    document.getElementById('statistics-link').addEventListener('click', () => {
      document.getElementById('detail-page').style.display = 'none';
      document.getElementById('statistics-page').style.display = 'block';
      document.getElementById('management-page').style.display = 'none';
      // 移除所有导航项的 active 类
      document.querySelectorAll('.sidebar a').forEach(link => link.classList.remove('active'));
      // 为当前选中的导航项添加 active 类
      document.getElementById('statistics-link').classList.add('active');
    });

    document.getElementById('management-link').addEventListener('click', () => {
      document.getElementById('detail-page').style.display = 'none';
      document.getElementById('statistics-page').style.display = 'none';
      document.getElementById('management-page').style.display = 'block';
      // 移除所有导航项的 active 类
      document.querySelectorAll('.sidebar a').forEach(link => link.classList.remove('active'));
      // 为当前选中的导航项添加 active 类
      document.getElementById('management-link').classList.add('active');
      updateManagementTables(); // 更新 Management 页面的表格
    });

    document.addEventListener("DOMContentLoaded", () => {
      filterTransactions('all');
      filterCategory();
      updateCategoryDropdown(); // 初始化下拉框
      updateManagementTables(); // 初始化 Management 页面的表格
    });
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
