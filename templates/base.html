{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="add-transaction-url" content="{% url 'add_transaction' %}">
  <meta name="delete-transaction-url" content="{% url 'delete_transaction' %}">
  <meta name="update-transaction-url" content="{% url 'update_transaction' %}">
  <meta name="add-category-url" content="{% url 'add_category' %}">
  <meta name="delete-category-url" content="{% url 'delete_category' %}">
  <meta name="add-budget-url" content="{% url 'add_budget' %}">
  <meta name="update-budget-url" content="{% url 'update_budget' %}">
  <meta name="delete-budget-url" content="{% url 'delete_budget' %}">
  <meta name="get-budgets-url" content="{% url 'get_budgets' %}">
  <meta name="add-currency-url" content="{% url 'add_currency' %}">
  <meta name="delete-currency-url" content="{% url 'delete_currency' %}">
  <meta name="add-account-url" content="{% url 'add_account' %}">
  <meta name="delete-account-url" content="{% url 'delete_account' %}">
  <meta name="get-accounts-url" content="{% url 'get_accounts' %}">
  <title>{% block title %}Wallet Notes{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    .sidebar {
      height: 100vh;
      background: #343a40;
      color: white;
      padding: 20px;
    }
    .sidebar a {
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      padding: 10px;
    }
    .sidebar a:hover {
      background: #495057;
    }
    .active {
      background: #6c757d !important;
    }
    .sidebar-logo {
      width: 20px;
      height: 20px;
      margin-right: 10px;
    }
    .logout-btn {
      position: absolute;  
      bottom: 20px;
      left: 20px;
      color: white;
      text-decoration: none;
      padding: 10px;
      display: flex;
      align-items: center;
    }
    .logout-btn:hover {
      color: #ff4444;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Side Bar -->
      <nav class="col-md-2 d-md-block sidebar">
        <h4>Wallet Notes</h4>
        <a href="{% url 'detail' %}" id="detail-link" class="{% block active_detail %}{% endblock %}">
          <img src="{% static 'img/detail.png' %}" alt="Detail Logo" class="sidebar-logo">
          Detail
        </a>
        <a href="{% url 'statistics' %}" id="statistics-link" class="{% block active_statistics %}{% endblock %}">
          <img src="{% static 'img/statistics.png' %}" alt="Statistics Logo" class="sidebar-logo">
          Statistics
        </a>
        <a href="{% url 'management' %}" id="management-link" class="{% block active_management %}{% endblock %}">
          <img src="{% static 'img/management.png' %}" alt="Management Logo" class="sidebar-logo">
          Management
        </a>
        <a href="{% url 'logout' %}" class="logout-btn">
          <i class="bi bi-box-arrow-left"></i>&nbsp;&nbsp;Logout
        </a>
      </nav>
      
      <!-- Main Content -->
      <main class="col-md-10 p-4">
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>
  
  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">Edit Transaction</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <div class="mb-3">
              <label for="editDate" class="form-label">Date</label>
              <input type="date" class="form-control" id="editDate" required>
            </div>
            <div class="mb-3">
              <label for="editType" class="form-label">Type</label>
              <select class="form-select" id="editType">
                <option value="true">Income</option>
                <option value="false">Expense</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editCategory" class="form-label">Category</label>
              <select class="form-select" id="editCategory"></select>
            </div>
            <div class="mb-3">
              <label for="editCurrency" class="form-label">Currency</label>
              <select class="form-select" id="editCurrency">
                <option value="GBP">GBP</option>
                <option value="EUR">EUR</option>
                <option value="USD">USD</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editAmount" class="form-label">Amount</label>
              <input type="text" class="form-control" id="editAmount" required>
            </div>
            <div class="mb-3">
              <label for="editAccount" class="form-label">Account</label>
              <select class="form-select" id="editAccount">
                <option value="cash">Cash</option>
                <option value="bank">Bank Account</option>
                <option value="credit_card">Credit Card</option>
                <option value="debit_card">Debit Card</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editDescription" class="form-label">Description</label>
              <input type="text" class="form-control" id="editDescription">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveChanges">Save changes</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Modal -->
  <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addModalLabel">Add Transaction</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addForm">
            <div class="mb-3">
              <label for="addDate" class="form-label">Date</label>
              <input type="date" class="form-control" id="addDate" required>
            </div>
            <div class="mb-3">
              <label for="addType" class="form-label">Type</label>
              <select class="form-select" id="addType">
                <option value="true">Income</option>
                <option value="false">Expense</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="addCategory" class="form-label">Category</label>
              <select class="form-select" id="addCategory" required></select>
            </div>
            <div class="mb-3">
              <label for="addCurrency" class="form-label">Currency</label>
              <select class="form-select" id="addCurrency">
                <option value="GBP">GBP</option>
                <option value="EUR">EUR</option>
                <option value="USD">USD</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="addAmount" class="form-label">Amount</label>
              <input type="text" class="form-control" id="addAmount" required>
            </div>
            <div class="mb-3">
              <label for="addAccount" class="form-label">Account</label>
              <select class="form-select" id="addAccount">
                <option value="Cash">Cash</option>
                <option value="Bank">Bank Account</option>
                <option value="Credit Card">Credit Card</option>
                <option value="Debit Card">Debit Card</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="addDescription" class="form-label">Description</label>
              <input type="text" class="form-control" id="addDescription">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="addTransaction">Add</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Income Category Modal -->
  <div class="modal fade" id="addIncomeCategoryModal" tabindex="-1" aria-labelledby="addIncomeCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addIncomeCategoryModalLabel">Add Income Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addIncomeCategoryForm">
            <div class="mb-3">
              <label for="incomeCategoryName" class="form-label">Name</label>
              <input type="text" class="form-control" id="incomeCategoryName" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveIncomeCategory">Save</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Expense Category Modal -->
  <div class="modal fade" id="addExpenseCategoryModal" tabindex="-1" aria-labelledby="addExpenseCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addExpenseCategoryModalLabel">Add Expense Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addExpenseCategoryForm">
            <div class="mb-3">
              <label for="expenseCategoryName" class="form-label">Name</label>
              <input type="text" class="form-control" id="expenseCategoryName" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveExpenseCategory">Save</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Budget Modal -->
  <div class="modal fade" id="addBudgetModal" tabindex="-1" aria-labelledby="addBudgetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addBudgetModalLabel">Add Budget</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addBudgetForm">
            <div class="mb-3">
              <label for="budgetYearMonth" class="form-label">Year-Month</label>
              <input type="month" class="form-control" id="budgetYearMonth" required>
            </div>
            <div class="mb-3">
              <label for="addCategory" class="form-label">Category</label>
              <select class="form-select" id="budgetCategory" required></select>
            </div>
            <div class="mb-3">
              <label for="budgetAmount" class="form-label">Budget Amount</label>
              <input type="text" class="form-control" id="budgetAmount" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveBudget">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Budget Modal -->
  <div class="modal fade" id="editBudgetModal" tabindex="-1" aria-labelledby="editBudgetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editBudgetModalLabel">Edit Budget</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editBudgetForm">
            <input type="hidden" id="editBudgetId">
            <div class="mb-3">
              <label for="editBudgetYearMonth" class="form-label">Year-Month</label>
              <input type="month" class="form-control" id="editBudgetYearMonth" required>
            </div>
            <div class="mb-3">
              <label for="editBudgetCategory" class="form-label">Category</label>
              <select class="form-select" id="editBudgetCategory" required></select>
            </div>
            <div class="mb-3">
              <label for="editBudgetAmount" class="form-label">Budget Amount</label>
              <input type="text" class="form-control" id="editBudgetAmount" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="updateBudget">Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Currency Modal -->
  <div class="modal fade" id="addCurrencyModal" tabindex="-1" aria-labelledby="addCurrencyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addCurrencyModalLabel">Add Currency</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addCurrencyForm">
            <div class="mb-3">
              <label for="currency" class="form-label">Currency</label>
              <input type="text" class="form-control" id="currency" required>
            </div>
          </form>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="saveCurrency">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Account Modal -->
  <div class="modal fade" id="addAccountModal" tabindex="-1" aria-labelledby="addAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addAccountModalLabel">Add Account</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addAccountForm">
            <div class="mb-3">
              <label for="account" class="form-label">Account Name</label>
              <input type="text" class="form-control" id="accountName" required>
            </div>
            <div class="mb-3">
              <label for="addAccount" class="form-label">Account</label>
              <select class="form-select" id="addAccount">
                <option value="cash">Cash</option>
                <option value="bank">Bank Account</option>
                <option value="credit_card">Credit Card</option>
                <option value="debit_card">Debit Card</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="balance" class="form-label">Balance</label>
              <input type="text" class="form-control" id="addBalance" required>
            </div>
          </form>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="saveAccount">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  {% block page_scripts %}{% endblock %}

  <script>
    let currentEditIndex = null;
    // Store current filter state
    let currentFilterState = {
      transactionType: 'all',
      category: 'all'
    }

    // Filter transactions
    function getFilteredTransactions(){
      if(!window.transactions || !Array.isArray(window.transactions)) return [];

      let filtered = [...window.transactions];
      
      if (currentFilterState.transactionType === 'in') {
        filtered = filtered.filter(t => t.transaction_type === true);
      } else if (currentFilterState.transactionType === 'out') {
        filtered = filtered.filter(t => t.transaction_type === false);
      }

      if (currentFilterState.category !== 'all') {
        filtered = filtered.filter(t => t.category === currentFilterState.category);
      }

      return filtered;
    }

    // Update filter state and re-render tables
    function updateFilterState(filterType, value) {
      if (filterType === 'transactionType') {
        currentFilterState.transactionType = value;
        
        // highlight active button
        document.querySelectorAll('.btn-secondary, .btn-success, .btn-danger').forEach(btn => {
          btn.classList.remove('active');
        });
        
        if (value === 'all') {
          document.querySelector('.btn-secondary').classList.add('active');
        } else if (value === 'in') {
          document.querySelector('.btn-success').classList.add('active');
        } else if (value === 'out') {
          document.querySelector('.btn-danger').classList.add('active');
        }
      } else if (filterType === 'category') {
        currentFilterState.category = value;
      }

      const filteredData = getFilteredTransactions();
      refreshTables();
    }
    
    function setTransactionTypeFilter(type) {
      updateFilterState('transactionType', type);
    }

    function setCategoryFilter(){
      const filterEl = document.getElementById('category-filter');
      if (!filterEl) return;

      const selectedCategory = filterEl.value;
      updateFilterState('category', selectedCategory);
    }

    function filterTransactions(type) {
      setTransactionTypeFilter(type);
    }

    function filterCategory() {
      setCategoryFilter();
    }

    function refreshTables() {
      if (!document.getElementById('detail-page')) {
          console.log('Not on detail page, skipping table refresh.');
          return;
      }

      const filteredData = getFilteredTransactions();
      updateTable(filteredData, "transaction-table-month");
      updateTable(filteredData, "transaction-table-category");
      updateTable(filteredData, "transaction-table-saved");
    }

    function updateTable(data, tableId) {
        const tableElement = document.getElementById(tableId);
        if (!tableElement) {
            console.log(`Table with id ${tableId} not found, skipping update.`);
            return;
        }

        let tableContent = data.map((t, index) => `<tr>
            <td>${t.date}</td>
            <td>${t.category}</td>
            <td>${t.transaction_type ? "Income" : "Expense"}</td>
            <td>${t.currency}</td>
            <td>${t.amount}</td>
            <td>${t.account}</td>
            <td>${t.description}</td>
            <td>
                <button class='btn btn-success btn-sm' onclick="saveTransaction(${index})">Save</button>
            </td>
            <td>
                <button class='btn btn-warning btn-sm' onclick="openEditModal(${index})">Edit</button>
                <button class='btn btn-danger btn-sm' onclick="deleteTransaction(${index})">Delete</button>
            </td>
        </tr>`).join('');
        document.getElementById(tableId).innerHTML = tableContent || '<tr><td colspan="9" class="text-center">No data available</td></tr>';
    }

    function openAddModal() {
        const addModal = new bootstrap.Modal(document.getElementById('addModal'));
        addModal.show();
        updateCategoryDropdown(); // Update drop-down box
    }

    function openEditModal(index) {
      const transaction = window.transactions[index];
      if (!transaction) {
        console.error('Transaction not found at index:', index);
        return;
      }
      currentEditIndex = index;

      document.getElementById('editDate').value = transaction.date;
      const editTypeElement = document.getElementById('editType');
      editTypeElement.value = transaction.transaction_type ? "true" : "false";
      
      const editCategoryElement = document.getElementById('editCategory');
      updateEditCategoryDropdown(transaction.transaction_type ? "true" : "false");
      
      editCategoryElement.value = transaction.category;

      document.getElementById('editCurrency').value = transaction.currency;
      document.getElementById('editAmount').value = transaction.amount;
      document.getElementById('editAccount').value = transaction.account_name;
      document.getElementById('editDescription').value = transaction.description;

      const editModal = new bootstrap.Modal(document.getElementById('editModal'));
      editModal.show();
    }
    
    function updateEditCategoryDropdown(type) {
      const categoryDropdown = document.getElementById('editCategory');
      if (!categoryDropdown) return;
      
      categoryDropdown.innerHTML = '';
      
      if (!window.categories || !window.categories[type]) {
        console.error('Categories not defined or invalid type:', type);
        return;
      }
      
      window.categories[type].forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryDropdown.appendChild(option);
      });
      console.log(window.categories);
    }

     // Update drop-down box
     function updateCategoryDropdown() {
      const categoryDropdown = document.getElementById('addCategory');
      const addTypeEl = document.getElementById('addType');
      if (!categoryDropdown || !addTypeEl) return;

      const selectedType = addTypeEl.value;
      categoryDropdown.innerHTML = '';

      if (!window.categories || !window.categories[selectedType]) {
        console.error('Categories not defined or invalid type:', selectedType);
        return;
      }

      window.categories[selectedType].forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryDropdown.appendChild(option);
      });
      console.log(window.categories);
    }

    function updateBudgetCategoryDropdown(elementId = 'budgetCategory') {
      const categoryDropdown = document.getElementById(elementId);
      if (!categoryDropdown) return;

      categoryDropdown.innerHTML = '';

      // 添加一個預設選項
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = '-- Select Category --';
      categoryDropdown.appendChild(defaultOption);

      // 添加所有支出類別
      if (window.categories && window.categories['false']) {
        window.categories['false'].forEach(category => {
          const option = document.createElement('option');
          option.value = category.id;
          option.textContent = category.name;
          categoryDropdown.appendChild(option);
        });
      }
    }

    function deleteTransaction(index) {
      const transactionId = transactions[index].id;
      console.log('Deleting transaction:', transactionId);

      let deleteUrl = 'delete-transaction/';
      const urlMeta = document.querySelector('meta[name="delete-transaction-url"]');
      if (urlMeta) {
        deleteUrl = urlMeta.getAttribute('content');
      }
      
      console.log('Delete URL:', deleteUrl);

      fetch(deleteUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `transaction_id=${transactionId}`
      })
      .then(response => {
        console.log('HTTP response status:', response.status);
        return response.text();
      })
      .then(text => {
        console.log('Response text:', text);
        // try analyzing JSON, if failed, return original text
        try {
          return JSON.parse(text);
        } catch (e) {
          console.error('Failed to parse JSON:', e);
          return { status: 'error', message: 'Invalid JSON response: ' + text };
        }
      })
      .then(data => {
        console.log('Parsed data:', data);
        if (data.status === 'success') {
          transactions.splice(index, 1);
          refreshTables();
          console.log('Transaction deleted successfully:', data.message);
        } else {
          console.error('Failed to delete:', data.message);
          alert(`Failed to delete: ${data.message}`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the transaction. Please check console.');
      });
    }

  // For Statistics Page
  function initStatisticsPage() {
    console.log('Initializing statistics page...');

    // Get transaction data from backend
    fetch('/api/transactions/dates/')
      .then(response => response.json())
      .then(data => {
        window.monthsByYear = data.monthsByYear; 
        initYearOptions(data.years);
      initMonthOptions(data.monthsByYear[Math.max(...data.years)]);  // init month options for the latest year
      switchMode('year');
    })
    .catch(error => {
      console.error('Error fetching transaction dates:', error);
    });
  }

  function initYearOptions(availableYears) {
    const yearSelect = document.getElementById('yearSelect');
    if (!yearSelect) return;

    yearSelect.innerHTML = ''; // clear existing options
    
    // generate options based on available years
    availableYears.forEach(year => {
      const option = document.createElement('option');
      option.value = year;
      option.textContent = year;
      yearSelect.appendChild(option);
    });

    // set the latest year as default
    if (availableYears.length > 0) {
      yearSelect.value = Math.max(...availableYears);
    }
  }

  function initMonthOptions(availableMonths) {
    const monthSelect = document.getElementById('monthSelect');
    if (!monthSelect) return;

    monthSelect.innerHTML = ''; // clear existing options
  
    const monthNames = [
      'January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'
    ];

    // generate options based on available months
    availableMonths.forEach(month => {
      const option = document.createElement('option');
      option.value = month;
      option.textContent = monthNames[month - 1];
      monthSelect.appendChild(option);
    });

    // set the latest month as default
    if (availableMonths.length > 0) {
      monthSelect.value = Math.max(...availableMonths);
    }
  }

  function switchMode(mode) {
    // update button status
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    const activeBtn = document.querySelector(`.filter-btn[onclick="switchMode('${mode}')"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
    }

    // handle month dropdown
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    
    if (monthSelect) {
        if (mode === 'year') {
            monthSelect.disabled = true;
            monthSelect.value = '';
            monthSelect.style.color = 'transparent';
        } else {
            // when switch to month mode
            monthSelect.disabled = false;
            monthSelect.style.color = '';
            
            // get the selected year
            const selectedYear = yearSelect.value;
            
            // use the saved monthsByYear data to re-initialize month options
            if (window.monthsByYear && window.monthsByYear[selectedYear]) {
                initMonthOptions(window.monthsByYear[selectedYear]);
            }
        }
    }
    updateCharts(mode);
  }

  function handleYearChange() {
    const yearSelect = document.getElementById('yearSelect');
    if (yearSelect) {
      const selectedYear = yearSelect.value;
      console.log('Selected year:', selectedYear);
      
      // update month options
      if (window.monthsByYear && window.monthsByYear[selectedYear]) {
        initMonthOptions(window.monthsByYear[selectedYear]);
      }
      
      updateCharts('year');
    }
  }

  function handleMonthChange() {
    if (document.getElementById('monthSelect') && !document.getElementById('monthSelect').disabled) {
      updateCharts('month');  
    }
  }

  function updateCharts(mode) {
    const yearSelect = document.getElementById('yearSelect');
    const monthSelect = document.getElementById('monthSelect');
    
    if (!yearSelect) return;

    const selectedYear = yearSelect.value;
    const selectedMonth = (mode === 'month' && monthSelect && !monthSelect.disabled) 
        ? monthSelect.value 
        : null;

    const params = new URLSearchParams();
    params.append('year', selectedYear || '');
    params.append('mode', mode || 'year');
    if (selectedMonth) {
        params.append('month', selectedMonth);
    }

    const url = `/api/statistics/data/?${params.toString()}`;
    
    console.log('Fetching URL:', url);

    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => updateStatistics(data))
        .catch(error => {
            alert('Error updating statistics.');
        });
  }

// function updateLineChart(data, mode) {
    
// }

function updatePieChart(chart, data, type) {
    const categoryData = data[`${type}_by_category`];
    if (categoryData && Object.keys(categoryData).length > 0) {
        chart.data.labels = Object.keys(categoryData);
        chart.data.datasets[0].data = Object.values(categoryData);
        chart.data.datasets[0].backgroundColor = ['#A8DFF1', '#ECBA73', '#F5E2D4', '#024757', '#E5989B'];
        chart.data.datasets[0].datalabels.color = '#FFCE56';
    } else {
        chart.data.labels = [`No ${type.charAt(0).toUpperCase() + type.slice(1)} Data`];
        chart.data.datasets[0].data = [1];
        chart.data.datasets[0].backgroundColor = ['#E0E0E0'];
        chart.data.datasets[0].datalabels.color = '#FFCE56';
    }
    chart.update();
}

  function updateRankingTable(data, type) {
    const tableId = type === 'expense' ? 'expenseRankingTable' : 'incomeRankingTable';
    const rankingTable = document.getElementById(tableId);
    if (!rankingTable) return;

    // clear existing content
    rankingTable.innerHTML = '';

    const createEmptyRows = (startIndex, count) => {
        for (let i = startIndex; i < count; i++) {
            const row = document.createElement('tr');
            row.className = `rank-item ${type}${i + 1}`;
            row.innerHTML = `
                <td>${i + 1}</td>
                <td>-</td>
                <td>0.00 £</td>
            `;
            rankingTable.appendChild(row);
        }
    };

    const categoryData = data[`${type}_by_category`];
    if (categoryData && Object.keys(categoryData).length > 0) {
        // convert category and amount to array and sort
        const items = Object.entries(categoryData)
            .map(([category, amount]) => ({category, amount}))
            .sort((a, b) => b.amount - a.amount)
            .slice(0, 5);

        items.forEach((item, index) => {
            const row = document.createElement('tr');
            row.className = `rank-item ${type}${index + 1}`;
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${item.category}</td>
                <td>${item.amount.toFixed(2)} £</td>
            `;
            rankingTable.appendChild(row);
        });

        // if no data, show 5 empty rows
        createEmptyRows(items.length, 5);
    } else {
        // if no data, show 5 empty rows
        createEmptyRows(0, 5);
    }
  }

  function updateExpenseRanking(data) {
    updateRankingTable(data, 'expense');
  }

  function updateIncomeRanking(data) {
    updateRankingTable(data, 'income');
  }

  function updateStatistics(data) {
    try {
        console.log('Updating statistics with data:', data);
        
        const formatCurrency = (number) => {
            const prefix = number >= 0 ? '+' : '';
            return `${prefix}${number.toFixed(2)} £`;
        };

        // update statistics block
        const incomeElement = document.querySelector('.stat-item.in h3');
        const expenseElement = document.querySelector('.stat-item.out h3');
        const balanceElement = document.querySelector('.stat-item.balance h3');
        const balanceBox = document.querySelector('.stat-item.balance');
        const mode = document.getElementById('monthSelect').value === '0' ? 'year' : 'month';


        if (incomeElement) incomeElement.textContent = formatCurrency(data.income);
        if (expenseElement) expenseElement.textContent = formatCurrency(-data.expense);
        if (balanceElement) {
            balanceElement.textContent = formatCurrency(data.balance);
            if (balanceBox) {
                if (data.balance < 0) {
                    balanceBox.style.backgroundColor = '#E50046'; 
                } else if (data.balance > 0) {
                    balanceBox.style.backgroundColor = '#1F7D53'; 
                } else {
                    balanceBox.style.backgroundColor = ''; 
                }
            }
        }

        // update income and expense line chart
        // updateLineChart(data, mode);

        // update expense pie chart
        if (typeof updateExpenseChart === 'function') {
            updateExpenseChart(data);
        }
        // update income pie chart
        if (typeof updateIncomeChart === 'function') {
            updateIncomeChart(data);
        }
        updatePieChart(expenseChart, data, 'expense');
        updatePieChart(incomeChart, data, 'income');
        // update expense ranking table
        updateExpenseRanking(data);
        // update income ranking table
        updateIncomeRanking(data);
    } catch (error) {
        console.error('Error in updateStatistics:', error);
        throw error;
    }
  }

    // initialize when DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById('statistics-page')) {
            initStatisticsPage();
            
            // rebind month selector event
            const monthSelect = document.getElementById('monthSelect');
            const yearSelect = document.getElementById('yearSelect');
            if (monthSelect) {
                monthSelect.addEventListener('change', handleMonthChange);
            }
            if (yearSelect) {
                yearSelect.addEventListener('change', handleYearChange);
            }
        }
    });

    document.getElementById('saveChanges').addEventListener('click', () => {
      if (currentEditIndex !== null) {
        const transaction = window.transactions[currentEditIndex];
        const transactionId = transaction.id;
        
        const updatedTransaction = {
          date: document.getElementById('editDate').value,
          category: document.getElementById('editCategory').value,
          transaction_type: document.getElementById('editType').value === 'true',
          currency: document.getElementById('editCurrency').value,
          amount: document.getElementById('editAmount').value,
          account: document.getElementById('editAccount').value,
          description: document.getElementById('editDescription').value
        };
        
        let updateUrl = 'update-transaction/';
        const updateUrlMeta = document.querySelector('meta[name="update-transaction-url"]');
        if (updateUrlMeta) {
          updateUrl = updateUrlMeta.getAttribute('content');
        }
        
        fetch('/update-transaction/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            'id': window.transactions[currentEditIndex].id,
            'date': updatedTransaction.date,
            'category': updatedTransaction.category,
            'transaction_type': updatedTransaction.transaction_type,
            'currency': updatedTransaction.currency,
            'amount': updatedTransaction.amount,
            'account': updatedTransaction.account,
            'description': updatedTransaction.description
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            window.transactions[currentEditIndex] = {
              ...transaction,
              ...updatedTransaction
            };
            
            refreshTables();
            
            // 重新加載頁面以反映類別總金額的變更
            // 或者可以新增一個API來獲取最新的類別數據
            window.location.reload();
          } else {
            console.error('Failed to update:', data.message);
            alert(`Failed to update: ${data.message}`);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while updating the transaction');
        });
        
        document.getElementById('saveChanges').blur();
        const editModal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
        editModal.hide();
      }
    });

    document.getElementById('addTransaction').addEventListener('click', () => {
      const newTransaction = {
        date: document.getElementById('addDate').value,
        category: document.getElementById('addCategory').value,
        transaction_type: document.getElementById('addType').value === 'true',
        currency: document.getElementById('addCurrency').value,
        amount: document.getElementById('addAmount').value,
        account: document.getElementById('addAccount').value,
        description: document.getElementById('addDescription').value
      }

      let addUrl = 'add-transaction/';
      const addUrlMeta = document.querySelector('meta[name="add-transaction-url"]');
      if (addUrlMeta) {
        addUrl = addUrlMeta.getAttribute('content');
      }
      
      fetch('/add-transaction/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          'date': newTransaction.date,
          'category': newTransaction.category,
          'transaction_type': newTransaction.transaction_type,
          'currency': newTransaction.currency,
          'amount': newTransaction.amount,
          'account': newTransaction.account,
          'description': newTransaction.description
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          newTransaction.id = data.id || Date.now();
          transactions.push(newTransaction);
          refreshTables();
          calculateRemainingBudget();

          window.location.reload();
        } else {
          console.error('Failed to add:', data.message);
          alert(`Failed to add: ${data.message}`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while adding the transaction');
      });

      // document.getElementById('addTransaction').blur();
      const addModal = bootstrap.Modal.getInstance(document.getElementById('addModal'));
      addModal.hide();
    });

    function updateCategoryTables() {
      const incomeTable = document.getElementById('income-categories-table');
      const expenseTable = document.getElementById('expense-categories-table');
      
      if (!incomeTable || !expenseTable) {
        console.log('Category tables not found, skipping update');
        return;
      }
      
      if (!window.categories) {
        console.error('Categories not defined');
        return;
      }
      
      console.log('Updating management tables with:', window.categories);
      
      // 更新收入類別表格
      if (Array.isArray(window.categories.true)) {
        incomeTable.innerHTML = window.categories.true.length > 0 ?
          window.categories.true.map(cat => `
            <tr>
              <td>${cat.name}</td>
              <td>${cat.transaction_count}</td>
              <td>£${cat.total_amount}</td>
              <td>
                <button class='btn btn-danger btn-sm' onclick="deleteCategory('true', ${cat.id})">Delete</button>
              </td>
            </tr>
          `).join('') :
          '<tr><td colspan="4" class="text-center">No income categories available</td></tr>';
      }
    
      // 更新支出類別表格
      if (Array.isArray(window.categories.false)) {
        expenseTable.innerHTML = window.categories.false.length > 0 ?
          window.categories.false.map(cat => `
            <tr>
              <td>${cat.name}</td>
              <td>${cat.transaction_count}</td>
              <td>£${cat.total_amount}</td>
              <td>
                <button class='btn btn-danger btn-sm' onclick="deleteCategory('false', ${cat.id})">Delete</button>
              </td>
            </tr>
          `).join('') :
          '<tr><td colspan="4" class="text-center">No expense categories available</td></tr>';
      }
    }
      
    // 全局变量：存储 budgets
    let budgets = [];

    function loadBudgets() {
      let getBudgetsUrl = 'get-budgets/';
      const getBudgetsUrlMeta = document.querySelector('meta[name="get-budgets-url"]');
      if (getBudgetsUrlMeta) {
        getBudgetsUrl = getBudgetsUrlMeta.getAttribute('content');
      }
      
      fetch(getBudgetsUrl)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            budgets = data.budgets;
            updateBudgetTable();
          } else {
            console.error('Failed to load budgets:', data.message);
          }
        })
        .catch(error => {
          console.error('Error loading budgets:', error);
        });
    }

    function openAddBudgetModal() {
      document.getElementById('budgetYearMonth').value = '';
      document.getElementById('budgetAmount').value = '';
      updateBudgetCategoryDropdown('budgetCategory');
      const addBudgetModal = new bootstrap.Modal(document.getElementById('addBudgetModal'));
      addBudgetModal.show();
    }

    function openEditBudgetModal(budgetId) {
      const budget = budgets.find(b => b.id == budgetId);
      if (!budget) {
        console.error('Budget not found:', budgetId);
        return;
      }
      
      document.getElementById('editBudgetId').value = budget.id;
      document.getElementById('editBudgetYearMonth').value = budget.period;
      document.getElementById('editBudgetAmount').value = budget.budget_amount;
      
      updateBudgetCategoryDropdown('editBudgetCategory');
      
      // 設置選中的類別
      setTimeout(() => {
        document.getElementById('editBudgetCategory').value = budget.category_id;
      }, 100);
      
      const editBudgetModal = new bootstrap.Modal(document.getElementById('editBudgetModal'));
      editBudgetModal.show();
    }

    document.getElementById('saveBudget').addEventListener('click', () => {
      const yearMonth = document.getElementById('budgetYearMonth').value;
      const amount = document.getElementById('budgetAmount').value;
      const categoryEl = document.getElementById('budgetCategory');

      if (!yearMonth) {
        alert('Please select a year-month');
        return;
      }
      if (!amount || isNaN(parseFloat(amount))) {
        alert('Please enter a valid amount');
        return;
      }
      if (!categoryEl.value) {
        alert('Please select a category');
        return;
      }
      
      let addBudgetUrl = 'add-budget/';
      const addBudgetUrlMeta = document.querySelector('meta[name="add-budget-url"]');
      if (addBudgetUrlMeta) {
        addBudgetUrl = addBudgetUrlMeta.getAttribute('content');
      }
      
      fetch(addBudgetUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          'period': yearMonth,
          'category_id': categoryEl.value,
          'budget_amount': amount
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          loadBudgets();
          const addBudgetModal = bootstrap.Modal.getInstance(document.getElementById('addBudgetModal'));
          addBudgetModal.hide();
        } else {
          console.error('Failed to add budget:', data.message);
          alert(`Failed to add budget: ${data.message}`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error adding budget. Please check console.');
      });
    });

    document.getElementById('updateBudget').addEventListener('click', () => {
      const budgetId = document.getElementById('editBudgetId').value;
      const yearMonth = document.getElementById('editBudgetYearMonth').value;
      const amount = document.getElementById('editBudgetAmount').value;
      const categoryEl = document.getElementById('editBudgetCategory');
      
      if (!yearMonth) {
        alert('Please select a year-month');
        return;
      }
      if (!amount || isNaN(parseFloat(amount))) {
        alert('Please enter a valid amount');
        return;
      }
      if (!categoryEl.value) {
        alert('Please select a category');
        return;
      }
      
      let updateBudgetUrl = 'update-budget/';
      const updateBudgetUrlMeta = document.querySelector('meta[name="update-budget-url"]');
      if (updateBudgetUrlMeta) {
        updateBudgetUrl = updateBudgetUrlMeta.getAttribute('content');
      }
      
      fetch(updateBudgetUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          'budget_id': budgetId,
          'period': yearMonth,
          'category_id': categoryEl.value,
          'budget_amount': amount
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          loadBudgets();
          const editBudgetModal = bootstrap.Modal.getInstance(document.getElementById('editBudgetModal'));
          editBudgetModal.hide();
        } else {
          console.error('Failed to update budget:', data.message);
          alert(`Failed to update budget: ${data.message}`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error updating budget. Please check console.');
      });
    });

    function deleteBudget(budgetId) {
      if (!confirm('You are about to delete this budget. Are you sure?')) {
        return;
      }
      
      let deleteBudgetUrl = 'delete-budget/';
      const deleteBudgetUrlMeta = document.querySelector('meta[name="delete-budget-url"]');
      if (deleteBudgetUrlMeta) {
        deleteBudgetUrl = deleteBudgetUrlMeta.getAttribute('content');
      }
      
      fetch(deleteBudgetUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `budget_id=${budgetId}`
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          loadBudgets();
        } else {
          console.error('Failed to delete budget:', data.message);
          alert(`Failed to delete budget: ${data.message}`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error deleting budget. Please check console.');
      });
    }

    function updateBudgetTable() {
      const tableBody = document.getElementById('budget-table');
      if (!tableBody) return;
      tableBody.innerHTML = budgets.length > 0 ?
        budgets.map(budget => `
          <tr>
            <td>${budget.period}</td>
            <td>${budget.category_name}</td>
            <td>£${parseFloat(budget.budget_amount).toFixed(2)}</td>
            <td>£${parseFloat(budget.remaining_amount).toFixed(2)}</td>
            <td>
              <button class="btn btn-warning btn-sm" onclick="openEditBudgetModal(${budget.id})">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteBudget(${budget.id})">Delete</button>
            </td>
          </tr>
        `).join('') :
        '<tr><td colspan="5" class="text-center">No budgets available</td></tr>';
    }

    function calculateRemainingBudget() {
      budgets.forEach(budget => {
        const [year, month] = budget.yearMonth.split('-'); // 解析年份和月份
        let totalSpent = 0;

        // 计算指定年份和月份的支出
        totalSpent = transactions
          .filter(transaction => {
            const transactionDate = new Date(transaction.date);
            return (
              transactionDate.getFullYear() === parseInt(year) &&
              transactionDate.getMonth() + 1 === parseInt(month) && // 月份从 0 开始，需要 +1
              transaction.amount.startsWith('-') // 只计算支出
            );
          })
          .reduce((sum, transaction) => sum + Math.abs(parseFloat(transaction.amount.replace('£', ''))), 0);

        // 更新剩余额度
        budget.remainingAmount = budget.amount - totalSpent;
      });

      updateBudgetTable(); // 更新表格
    }

    function openAddCurrencyModal() {
      const addCurrencyModal = new bootstrap.Modal(document.getElementById('addCurrencyModal'));
      addCurrencyModal.show();
    }

    function openAddAccountModal() {
      const addAccountModal = new bootstrap.Modal(document.getElementById('addAccountModal'));
      addAccountModal.show();
    }
      

    // 在 DOMContentLoaded 事件內添加這些
    document.getElementById('addType').addEventListener('change', function() {
      updateCategoryDropdown();
    });

    document.getElementById('editType').addEventListener('change', function() {
      updateEditCategoryDropdown(this.value);
    });

    function deleteCategory(is_income, categoryId) {
      console.log('Deleting category:', categoryId);
      if (!confirm('Are you sure you want to delete this category?')) {
        return;
      }

      let deleteUrl = 'delete-category/';
      const urlMeta = document.querySelector('meta[name="delete-category-url"]');
      if (urlMeta) {
        deleteUrl = urlMeta.getAttribute('content');
      }
      console.log('Delete URL:', deleteUrl);

      fetch(deleteUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `category_id=${categoryId}`
      })
      .then(response => {
        console.log('HTTP response status:', response.status);
        return response.text();
      })
      .then(text => {
        console.log('Response text:', text);
        // try analyzing JSON, if failed, return original text
        try {
          return JSON.parse(text);
        } catch (e) {
          console.error('Failed to parse JSON:', e);
          return { status: 'error', message: 'Invalid JSON response: ' + text };
        }
      })
      .then(data => {
        console.log('Parsed data:', data);
        if (data.status === 'success') {
          window.categories[is_income] = categories[is_income].filter(c => c.id !== categoryId);
          updateCategoryTables();
          updateCategoryDropdown();
          console.log('Category deleted successfully:', data.message);
        } else {
          console.error('Failed to delete:', data.message);
          alert(`Failed to delete: ${data.message}`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the category. Please check console.');
      });
    }

    function openAddIncomeCategoryModal() {
      document.getElementById('incomeCategoryName').value = ''; // Clear the input box
      const addIncomeCategoryModal = new bootstrap.Modal(document.getElementById('addIncomeCategoryModal'));
      addIncomeCategoryModal.show();
    }

    function openAddExpenseCategoryModal() {
      document.getElementById('expenseCategoryName').value = ''; // Clear the input box
      const addExpenseCategoryModal = new bootstrap.Modal(document.getElementById('addExpenseCategoryModal'));
      addExpenseCategoryModal.show();
    }

    document.getElementById('saveIncomeCategory').addEventListener('click', () => {
      const categoryName = document.getElementById('incomeCategoryName').value;

      let addCategoryUrl = 'add-category/';
      const addCategoryUrlMeta = document.querySelector('meta[name="add-category-url"]');
      if (addCategoryUrlMeta) {
        addCategoryUrl = addCategoryUrlMeta.getAttribute('content');
      }

      fetch(addCategoryUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          'name': categoryName,
          'is_income': 'true'
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          window.categories['true'].push({
            id: data.id || Date.now(), // 如果後端沒有返回ID，使用時間戳作為臨時ID
            name: data.name || categoryName,
            transaction_count: 0,
            total_amount: "0.00"
          });
          updateCategoryTables();
          updateCategoryDropdown();
        } else if(data.status === 'exists'){
            alert("Category already exists");          
        }else {
          alert(data.message);
        }
        const modal = bootstrap.Modal.getInstance(document.getElementById('addIncomeCategoryModal'));
        modal.hide();
      })
      .catch(error => {
        alert('Error when adding income category');
      });
    });

    document.getElementById('saveExpenseCategory').addEventListener('click', () => {
      const categoryName = document.getElementById('expenseCategoryName').value;

      let addCategoryUrl = 'add-category/';
      const addCategoryUrlMeta = document.querySelector('meta[name="add-category-url"]');
      if (addCategoryUrlMeta) {
        addCategoryUrl = addCategoryUrlMeta.getAttribute('content');
      }

      fetch(addCategoryUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          'name': categoryName,
          'is_income': 'false'
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          window.categories['false'].push({
            id: data.id || Date.now(), // 如果後端沒有返回ID，使用時間戳作為臨時ID
            name: data.name || categoryName,
            transaction_count: 0,
            total_amount: "0.00"
          });
          updateCategoryTables();
          updateCategoryDropdown();
        } else if(data.status === 'exists'){
            alert("Category already exists");          
        }else {
          alert(data.message);
        }
        const modal = bootstrap.Modal.getInstance(document.getElementById('addExpenseCategoryModal'));
        modal.hide();
      })
      .catch(error => {
        alert('Error when adding expense category');
      });
    });

    document.getElementById('saveCurrency').addEventListener('click', () => {
      const currencyName = document.getElementById('currency').value;

      let addCurrencyUrl = 'add-currency/';
      const addCurrencyUrlMeta = document.querySelector('meta[name="add-currency-url"]');
      if (addCurrencyUrlMeta) {
        addCurrencyUrl = addCurrencyUrlMeta.getAttribute('content');
      }

      fetch(addCurrencyUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          'name': currencyName
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          updateCategoryTables();
        } else if(data.status === 'exists'){
            alert("Currency already exists");          
        }else {
          alert(data.message);
        }
        const modal = bootstrap.Modal.getInstance(document.getElementById('addCurrencyModal'));
        modal.hide();
      })
      .catch(error => {
        alert('Error when adding currency');
      });
    });

    function deleteCurrency(id) {
      const deleteCurrencyUrl = 'delete-currency/';
      const deleteCurrencyUrlMeta = document.querySelector('meta[name="delete-currency-url"]');
      if (deleteCurrencyUrlMeta) {
        deleteCurrencyUrl = deleteCurrencyUrlMeta.getAttribute('content');
      }

      fetch(deleteCurrencyUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `id=${id}`
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          window.currencies = window.currencies.filter(c => c.id !== id);
          updateCategoryTables();
        } else {
          alert(data.message);
        }
      })
      .catch(error => {
        alert('Error when deleting currency');
      });
    }

    function loadAccounts() {
      let getAccountsUrl = 'get-accounts/';
      const getAccountsUrlMeta = document.querySelector('meta[name="get-accounts-url"]');
      if (getAccountsUrlMeta) {
        getAccountsUrl = getAccountsUrlMeta.getAttribute('content');
      }
      
      fetch(getAccountsUrl)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            accounts = data.accounts;
            updateAccountTable();
          } else {
            console.error('Failed to load accounts:', data.message);
          }
        })
        .catch(error => {
          console.error('Error loading accounts:', error);
        });
    }

    function updateAccountTable() {
      const accountTable = document.getElementById('account-table');
      if (!accountTable) {
        console.error('Account table not found');
        return;
      }
      
      if (!window.accounts) {
        console.error('Accounts not defined');
        return;
      }
      
      accountTable.innerHTML = '';
      
      window.accounts.forEach(account => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${account.account_name}</td>
          <td>${account.account_type}</td>
          <td>${account.balance}</td>
          <td>
            <button class="btn btn-danger btn-sm" onclick="deleteAccount(${account.id})">Delete</button>
          </td>
        `;
        accountTable.appendChild(row);
      });
    }

    document.getElementById('saveAccount').addEventListener('click', () => {
      const accountName = document.getElementById('accountName').value;
      const accountType = document.getElementById('addAccount').value;
      const balance = document.getElementById('addBalance').value;

      let addAccountUrl = 'add-account/';
      const addAccountUrlMeta = document.querySelector('meta[name="add-account-url"]');
      if (addAccountUrlMeta) {
        addAccountUrl = addAccountUrlMeta.getAttribute('content');
      }

      fetch(addAccountUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          'account_name': accountName,
          'account_type': accountType,
          'balance': balance,
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          loadAccounts();
          document.getElementById('saveAccount').blur();
        } else if(data.status === 'exists'){
            alert("Account already exists");          
        }else {
          alert(data.message);
        }
        const modal = bootstrap.Modal.getInstance(document.getElementById('addAccountModal'));
        modal.hide();
      })
      .catch(error => {
        console.error('Error when adding account:', error);
        alert('Error when adding account' + error);
      });
    })

    function deleteAccount(account_id) {
      if (!confirm('You are about to delete this budget. Are you sure?')) {
        return;
      }

      let deleteAccountUrl = 'delete-account/';
      const deleteAccountUrlMeta = document.querySelector('meta[name="delete-account-url"]');
      if (deleteAccountUrlMeta) {
        deleteAccountUrl = deleteAccountUrlMeta.getAttribute('content');
      }

      fetch(deleteAccountUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `account_id=${account_id}`
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          window.accounts = window.accounts.filter(a => a.id !== id);
          loadAccounts();
        } else {
          alert(data.message);
        }
      })
      .catch(error => {
        alert('Error when deleting account:' + error);
      });
    }

    function exportToCSV() {
      const headers = ["Date", "Categories", "Pending", "Description"];
      const csvContent = "data:text/csv;charset=utf-8," 
          + headers.join(",") + "\n" 
          + transactions.map(t => 
              `${t.date},${t.category},${t.amount},${t.description}`
          ).join("\n");

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "transactions.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Initialize data
    function initializeData() {
      // 初始化交易數據
      const transactionsDataElement = document.getElementById('transactions_data');
      if (transactionsDataElement) {
        try {
          window.transactions = JSON.parse(transactionsDataElement.textContent);
        } catch (e) {
          console.error('Failed to parse transactions data:', e);
          window.transactions = [];
        }
      }
      
      // 只有在尚未設置 window.categories 時才初始化類別數據
      if (!window.categories) {
        const categoriesDataElement = document.getElementById('categories_data');
        if (categoriesDataElement) {
          try {
            window.categories = JSON.parse(categoriesDataElement.textContent);
            console.log('Successfully parsed categories:', window.categories);
          } catch (e) {
            console.error('Failed to parse categories data:', e);
            window.categories = {'true': [], 'false': []};
          }
        } else {
          console.warn('Categories data element not found, initializing empty categories');
          window.categories = {'true': [], 'false': []};
        }
      }
      
      // 確保類別結構完整
      if (!window.categories) {
        console.warn('Categories still not defined after initialization, creating empty object');
        window.categories = {};
      }
      
      if (!window.categories['true']) {
        console.warn('true category array not found, initializing empty array');
        window.categories['true'] = [];
      }
      
      if (!window.categories['false']) {
        console.warn('false category array not found, initializing empty array');
        window.categories['false'] = [];
      }
      
      console.log('Final categories structure:', window.categories);
    }

    document.addEventListener("DOMContentLoaded", () => {
      initializeData();

      if(document.getElementById('detail-page')){
        refreshTables();
        filterCategory();
        updateCategoryDropdown(); // Refresh drop-down box
      }
      
      if(document.getElementById('management-page')){
        updateCategoryTables(); // Initialize Management Table
      }

      if (document.getElementById('budget-table')) {
        loadBudgets();
      }

      if (document.getElementById('account-table')) {
        loadAccounts();
      }

      // Other general initialization
      updateBudgetTable();
      calculateRemainingBudget();
    }); // Added missing closing brace
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>